# =============================================================================
# DEVELOPMENT ENVIRONMENT
# =============================================================================
# Used when running: stack dev up
#
# This configuration:
# - Uses different ports to allow prod to run simultaneously
# - Uses separate database volumes to isolate dev data from prod
# - Optionally exposes dev via Traefik when DOMAIN_DEV is set
#
# Access points (direct):
#   Open WebUI:  http://localhost:3001
#   Agent API:   http://localhost:8001
#   PostgreSQL:  localhost:5433
#   Qdrant:      localhost:6334
#   LiteLLM:     localhost:4001
#   SearxNG:     localhost:8081
#
# Access points (via Traefik, when DOMAIN_DEV is set):
#   Open WebUI:  https://${DOMAIN_DEV}
#   Agent Admin: https://${DOMAIN_DEV}/platformadmin
# =============================================================================

services:
  # Agent with dev port and optional Traefik routing
  agent:
    ports:
      - "8001:8000"
    environment:
      AGENT_ENVIRONMENT: development
      # Use dev database (same credentials as prod, different db name)
      POSTGRES_URL: postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/agent_db_dev
    labels:
      # Enable Traefik routing for dev when DOMAIN_DEV is set
      - "traefik.enable=${DOMAIN_DEV:+true}"
      - "traefik.http.routers.agent-admin-dev.rule=Host(`${DOMAIN_DEV:-agent-dev.local}`) && PathPrefix(`/platformadmin`)"
      - "traefik.http.routers.agent-admin-dev.entrypoints=websecure"
      - "traefik.http.routers.agent-admin-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.agent-admin-dev.service=agent-admin-dev"
      - "traefik.http.services.agent-admin-dev.loadbalancer.server.port=8000"

  # Open WebUI with dev port and optional Traefik routing
  open-webui:
    ports:
      - "3001:8080"
    environment:
      # External URL for OAuth callbacks - defaults to localhost for local dev
      # When DOMAIN_DEV is set, uses https://DOMAIN_DEV
      - WEBUI_URL=http${DOMAIN_DEV:+s}://${DOMAIN_DEV:-localhost:3001}
      # Disable automatic signup - admin creates users manually
      - ENABLE_OAUTH_SIGNUP=false
    labels:
      # Enable Traefik routing for dev when DOMAIN_DEV is set
      - "traefik.enable=${DOMAIN_DEV:+true}"
      - "traefik.http.routers.openwebui-dev.rule=Host(`${DOMAIN_DEV:-agent-dev.local}`)"
      - "traefik.http.routers.openwebui-dev.entrypoints=websecure"
      - "traefik.http.routers.openwebui-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.openwebui-dev.service=openwebui-dev"
      - "traefik.http.services.openwebui-dev.loadbalancer.server.port=8080"
      # Security: Strip untrusted headers from external requests
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Email="
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Name="
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Id="
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Role="
      # Security: Enable HSTS
      - "traefik.http.middlewares.security-dev.headers.stsSeconds=31536000"
      - "traefik.http.routers.openwebui-dev.middlewares=strip-headers-dev,security-dev"

  # PostgreSQL with dev port and separate volume
  postgres:
    ports:
      - "5433:5432"
    environment:
      # Use same credentials as prod but different database name
      POSTGRES_DB: agent_db_dev
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data

  # Qdrant with dev port and separate data
  qdrant:
    ports:
      - "6334:6333"
    volumes:
      - ./data/qdrant_dev:/qdrant/storage

  # LiteLLM with dev port
  litellm:
    ports:
      - "4001:4000"

  # SearxNG with dev port
  searxng:
    ports:
      - "8081:8080"

volumes:
  # Separate volume for dev database
  postgres_data_dev:
