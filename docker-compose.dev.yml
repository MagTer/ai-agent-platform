# =============================================================================
# DEVELOPMENT ENVIRONMENT
# =============================================================================
# Used when running: stack dev up
#
# This configuration:
# - Uses separate database volumes to isolate dev data from prod
# - Routes all traffic through Traefik (same as prod) via DOMAIN_DEV
# - No direct port exposure -- all access via TLS through Traefik
#
# Access points (via Traefik, requires DOMAIN_DEV in .env):
#   Open WebUI:  https://${DOMAIN_DEV}
#   Agent Admin: https://${DOMAIN_DEV}/platformadmin
# =============================================================================

services:
  # Agent with dev database and Traefik routing
  agent:
    environment:
      AGENT_ENVIRONMENT: development
      # Use dev database (same credentials as prod, different db name)
      POSTGRES_URL: postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/agent_db_dev
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.agent-admin-dev.rule=Host(`${DOMAIN_DEV:-agent-dev.local}`) && PathPrefix(`/platformadmin`)"
      - "traefik.http.routers.agent-admin-dev.entrypoints=websecure"
      - "traefik.http.routers.agent-admin-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.agent-admin-dev.service=agent-admin-dev"
      - "traefik.http.services.agent-admin-dev.loadbalancer.server.port=8000"
      # Security: Strip untrusted X-OpenWebUI-* headers
      - "traefik.http.middlewares.strip-agent-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Email="
      - "traefik.http.middlewares.strip-agent-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Name="
      - "traefik.http.middlewares.strip-agent-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Id="
      - "traefik.http.middlewares.strip-agent-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Role="
      - "traefik.http.routers.agent-admin-dev.middlewares=strip-agent-headers-dev"

  # Open WebUI with separate data volume and Traefik routing
  open-webui:
    volumes:
      - ./data/openwebui_dev:/app/backend/data
    environment:
      - WEBUI_URL=https://${DOMAIN_DEV:-agent-dev.local}
      - ENABLE_OAUTH_SIGNUP=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openwebui-dev.rule=Host(`${DOMAIN_DEV:-agent-dev.local}`)"
      - "traefik.http.routers.openwebui-dev.entrypoints=websecure"
      - "traefik.http.routers.openwebui-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.openwebui-dev.service=openwebui-dev"
      - "traefik.http.services.openwebui-dev.loadbalancer.server.port=8080"
      # Security: Strip untrusted headers from external requests
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Email="
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Name="
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Id="
      - "traefik.http.middlewares.strip-headers-dev.headers.customrequestheaders.X-OpenWebUI-User-Role="
      # Security: Enable HSTS
      - "traefik.http.middlewares.security-dev.headers.stsSeconds=31536000"
      - "traefik.http.routers.openwebui-dev.middlewares=strip-headers-dev,security-dev"

  # PostgreSQL with separate volume
  postgres:
    environment:
      POSTGRES_DB: agent_db_dev
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data

  # Qdrant with separate data
  qdrant:
    volumes:
      - ./data/qdrant_dev:/qdrant/storage

  # LiteLLM healthcheck
  litellm:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  # Separate volume for dev database
  postgres_data_dev:
