# Continuous Integration Pipeline

The GitHub Actions workflow defined in [`.github/workflows/ci.yml`](../../.github/workflows/ci.yml)
validates every push to `main`, `feature/*`, and `fix/*` branches and all pull requests. All
jobs run on `ubuntu-latest`, use Python 3.11, and cache a project-scoped Poetry virtual
environment (`.venv`) together with the Poetry and pip caches keyed by `poetry.lock` and
`pyproject.toml`.

## Lint job

1. Check out the repository and install Poetry 1.8.2.
2. Force Poetry to create the in-repo virtual environment (`poetry config virtualenvs.in-project true`).
3. Restore the cached environment and install dependencies with `poetry install --no-interaction`.
4. Run static analysis steps:
   - `poetry run ruff check .` – Ruff is configured for a 100-character line length and Python 3.11 via
     `[tool.ruff]` in `pyproject.toml`.
   - `poetry run black --check src tests fetcher indexer ragproxy embedder` – Black also enforces the
     100-character maximum specified in `[tool.black]`.
   - `poetry run mypy src` – Uses the project type configuration from `[tool.mypy]`.

Only when all three checks succeed does the workflow proceed to the downstream jobs.

## Test job

The `test` job depends on the lint job. It repeats the checkout, Python, and Poetry setup so
that the cached virtual environment can be reused, then executes the coverage-enabled test
suite:

```bash
poetry run coverage run -m pytest
poetry run coverage report
```

The `coverage run` invocation collects metrics for the pytest session, and the subsequent
`coverage report` prints the summary directly to the job log.

## Compose configuration job

The `compose` job ensures that the default Docker Compose definition remains valid. After
checking out the repository it prepares a local `.env` from `.env.template` and runs:

```bash
docker compose -f docker-compose.yml config
```

This guards against configuration regressions that would break local orchestration.

## Local pre-flight checklist

Before opening a pull request, run the same commands locally to match CI expectations:

```bash
poetry install --no-interaction
poetry run ruff check .
poetry run black --check src tests fetcher indexer ragproxy embedder
poetry run mypy src
poetry run coverage run -m pytest
poetry run coverage report
```

Confirm that Ruff and Black report no formatting violations beyond the shared 100-character
line length, ensure mypy passes, and review the coverage summary before pushing. If you need to
apply formatting locally, run `poetry run black src tests fetcher indexer ragproxy embedder`
without `--check` before re-running the lint command above.
