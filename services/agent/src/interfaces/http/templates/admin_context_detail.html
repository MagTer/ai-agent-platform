<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
    <a href="/platformadmin/contexts/" class="btn btn-sm">&larr; All Contexts</a>
    <div>
        <h1 class="page-title" style="margin-bottom: 0;" id="contextTitle">Loading...</h1>
        <div id="contextId" style="font-family: monospace; font-size: 12px; color: var(--text-muted);"></div>
    </div>
    <span class="badge" id="contextType"></span>
</div>

<div class="tab-bar">
    <button class="tab active" data-tab="overview" onclick="switchTab('overview')">Overview</button>
    <button class="tab" data-tab="permissions" onclick="switchTab('permissions')">Permissions</button>
    <button class="tab" data-tab="credentials" onclick="switchTab('credentials')">Credentials</button>
    <button class="tab" data-tab="workspaces" onclick="switchTab('workspaces')">Workspaces</button>
    <button class="tab" data-tab="mcp" onclick="switchTab('mcp')">MCP Servers</button>
    <button class="tab" data-tab="scheduler" onclick="switchTab('scheduler')">Scheduler</button>
    <button class="tab" data-tab="files" onclick="switchTab('files')">Files</button>
    <button class="tab" data-tab="skills" onclick="switchTab('skills')">Skills</button>
</div>

<div id="tab-overview" class="tab-content active">
    <div class="card" id="overviewCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<div id="tab-permissions" class="tab-content" style="display:none;">
    <div class="card" id="permissionsCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<div id="tab-credentials" class="tab-content" style="display:none;">
    <div class="card" id="credentialsCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<div id="tab-workspaces" class="tab-content" style="display:none;">
    <div class="card" id="workspacesCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<div id="tab-mcp" class="tab-content" style="display:none;">
    <div class="card" id="mcpCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<div id="tab-scheduler" class="tab-content" style="display:none;">
    <div class="card" id="schedulerCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<div id="tab-files" class="tab-content" style="display:none;">
    <div class="card" id="filesCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<div id="tab-skills" class="tab-content" style="display:none;">
    <div class="card" id="skillsCard">
        <div class="loading">Loading...</div>
    </div>
</div>

<!-- Add Credential Modal -->
<div id="addCredModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Add Azure DevOps PAT</h3>
        <form id="addCredForm" onsubmit="submitCredential(event)">
            <div class="form-group">
                <label>PAT Value</label>
                <textarea id="credValue" required placeholder="Enter your Azure DevOps PAT (will be encrypted)" style="min-height: 80px; font-family: monospace;"></textarea>
                <small style="color: var(--text-muted); font-size: 12px;">Encrypted at rest using Fernet encryption.</small>
            </div>
            <div class="form-group">
                <label>DevOps URL (including project) *</label>
                <input type="text" id="credOrgUrl" required placeholder="https://dev.azure.com/YourOrg/YourProject" pattern="^https://dev\.azure\.com/[^/]+(/[^/]+)?/?$">
                <small style="color: var(--text-muted); font-size: 12px;">e.g., https://dev.azure.com/Org/Project</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideCredModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Credential</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Scheduled Job Modal -->
<div id="createJobModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Create Scheduled Job</h3>
        <form id="createJobForm" onsubmit="submitJob(event)">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="jobName" required placeholder="e.g., daily-report" pattern="^[a-zA-Z0-9_\- ]+$">
            </div>
            <div class="form-group">
                <label>Prompt *</label>
                <textarea id="jobPrompt" required placeholder="What should the agent do?" style="min-height: 80px;"></textarea>
            </div>
            <div class="form-group">
                <label>Cron Expression *</label>
                <select id="cronPresets" onchange="applyCronPreset()" style="margin-bottom: 4px;">
                    <option value="">-- Pick a common schedule --</option>
                    <option value="0 */4 * * *">Every 4 hours</option>
                    <option value="0 */6 * * *">Every 6 hours</option>
                    <option value="0 9 * * *">Daily at 9am UTC</option>
                    <option value="0 9,17 * * *">Twice daily (9am, 5pm UTC)</option>
                    <option value="0 8 * * 1-5">Weekdays at 8am UTC</option>
                </select>
                <input type="text" id="jobCron" required placeholder="0 8 * * 1-5 (weekdays at 08:00)">
                <small style="color: var(--text-muted); font-size: 12px;">Format: minute hour day month weekday. Example: 0 9 * * * = daily at 09:00 UTC</small>
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="jobDescription" placeholder="Optional description">
            </div>
            <div class="form-group">
                <label>Notification Channel</label>
                <select id="jobNotifChannel" onchange="toggleNotifTarget()">
                    <option value="">None</option>
                    <option value="email">Email</option>
                    <option value="telegram">Telegram</option>
                </select>
            </div>
            <div class="form-group" id="notifTargetGroup" style="display:none;">
                <label>Notification Target</label>
                <input type="text" id="jobNotifTarget" placeholder="Email address or Telegram chat ID">
            </div>
            <div class="form-group">
                <label>Timeout (seconds)</label>
                <input type="number" id="jobTimeout" value="300" min="30" max="3600">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideJobModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Job</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Scheduled Job Modal -->
<div id="editJobModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Edit Scheduled Job</h3>
        <form id="editJobForm" onsubmit="submitEditJob(event)">
            <input type="hidden" id="editJobId">
            <div class="form-group">
                <label>Prompt *</label>
                <textarea id="editJobPrompt" required placeholder="What should the agent do?" style="min-height: 80px;"></textarea>
            </div>
            <div class="form-group">
                <label>Cron Expression *</label>
                <select id="editCronPresets" onchange="applyEditCronPreset()" style="margin-bottom: 4px;">
                    <option value="">-- Pick a common schedule --</option>
                    <option value="0 */4 * * *">Every 4 hours</option>
                    <option value="0 */6 * * *">Every 6 hours</option>
                    <option value="0 9 * * *">Daily at 9am UTC</option>
                    <option value="0 9,17 * * *">Twice daily (9am, 5pm UTC)</option>
                    <option value="0 8 * * 1-5">Weekdays at 8am UTC</option>
                </select>
                <input type="text" id="editJobCron" required placeholder="0 8 * * 1-5">
                <small style="color: var(--text-muted); font-size: 12px;">Format: minute hour day month weekday</small>
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="editJobDescription" placeholder="Optional description">
            </div>
            <div class="form-group">
                <label>Notification Channel</label>
                <select id="editJobNotifChannel" onchange="toggleEditNotifTarget()">
                    <option value="">None</option>
                    <option value="email">Email</option>
                    <option value="telegram">Telegram</option>
                </select>
            </div>
            <div class="form-group" id="editNotifTargetGroup" style="display:none;">
                <label>Notification Target</label>
                <input type="text" id="editJobNotifTarget" placeholder="Email address or Telegram chat ID">
            </div>
            <div class="form-group">
                <label>Timeout (seconds)</label>
                <input type="number" id="editJobTimeout" value="300" min="30" max="3600">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideEditJobModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Context Modal -->
<div id="editContextModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Edit Context</h3>
        <form id="editContextForm" onsubmit="submitEditContext(event)">
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="editCtxDisplayName" placeholder="Friendly display name (optional)">
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="editCtxName" required>
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="editCtxType">
                    <option value="personal">Personal</option>
                    <option value="shared">Shared</option>
                    <option value="virtual">Virtual</option>
                    <option value="git_repo">Git Repo</option>
                    <option value="devops">DevOps</option>
                </select>
            </div>
            <div class="form-group">
                <label>Default CWD</label>
                <input type="text" id="editCtxCwd">
            </div>
            <div class="form-group">
                <label>Memory File Name</label>
                <input type="text" id="editCtxMemoryFile" placeholder="memory.md">
                <small style="color: var(--text-muted); font-size: 12px;">Name of the memory file in this context's files directory</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideEditContextModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Add Member</h3>
        <form id="addMemberForm" onsubmit="submitAddMember(event)">
            <div class="form-group">
                <label>User Email</label>
                <input type="email" id="memberEmail" required placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="memberRole">
                    <option value="member">Member</option>
                    <option value="viewer">Viewer</option>
                    <option value="owner">Owner</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideAddMemberModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Member</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Workspace Modal -->
<div id="addWorkspaceModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Clone Repository</h3>
        <form id="addWorkspaceForm" onsubmit="submitAddWorkspace(event)">
            <div class="form-group">
                <label>Repository URL *</label>
                <input type="url" id="wsRepoUrl" required placeholder="https://github.com/org/repo.git">
            </div>
            <div class="form-group">
                <label>Name (optional)</label>
                <input type="text" id="wsName" placeholder="Derived from URL if empty">
            </div>
            <div class="form-group">
                <label>Branch (optional)</label>
                <input type="text" id="wsBranch" placeholder="main">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideWorkspaceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Clone</button>
            </div>
        </form>
    </div>
</div>

<!-- Add MCP Server Modal -->
<div id="addMcpModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 id="mcpModalTitle">Add MCP Server</h3>
        <form id="addMcpForm" onsubmit="submitMcpServer(event)">
            <input type="hidden" id="mcpEditId" value="">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="mcpName" required placeholder="e.g., my-mcp-server">
            </div>
            <div class="form-group">
                <label>URL *</label>
                <input type="url" id="mcpUrl" required placeholder="https://mcp.example.com/sse">
            </div>
            <div class="form-group">
                <label>Transport</label>
                <select id="mcpTransport">
                    <option value="auto">Auto</option>
                    <option value="sse">SSE</option>
                    <option value="streamable_http">Streamable HTTP</option>
                </select>
            </div>
            <div class="form-group">
                <label>Auth Type</label>
                <select id="mcpAuthType" onchange="toggleMcpAuthFields()">
                    <option value="none">None</option>
                    <option value="bearer">Bearer Token</option>
                    <option value="oauth">OAuth 2.0</option>
                </select>
            </div>
            <div id="mcpBearerFields" style="display:none;">
                <div class="form-group">
                    <label>Bearer Token</label>
                    <input type="password" id="mcpAuthToken" placeholder="Token (encrypted at rest)">
                </div>
            </div>
            <div id="mcpOAuthFields" style="display:none;">
                <div class="form-group">
                    <label>Authorization URL</label>
                    <input type="url" id="mcpOAuthAuthUrl" placeholder="https://provider.com/oauth/authorize">
                </div>
                <div class="form-group">
                    <label>Token URL</label>
                    <input type="url" id="mcpOAuthTokenUrl" placeholder="https://provider.com/oauth/token">
                </div>
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="mcpOAuthClientId">
                </div>
                <div class="form-group">
                    <label>Client Secret</label>
                    <input type="password" id="mcpOAuthClientSecret">
                </div>
                <div class="form-group">
                    <label>Scopes</label>
                    <input type="text" id="mcpOAuthScopes" placeholder="scope1 scope2">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideMcpModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- New File Modal -->
<div id="newFileModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>New File</h3>
        <form id="newFileForm" onsubmit="submitNewFile(event)">
            <div class="form-group">
                <label>File Name *</label>
                <input type="text" id="newFileName" required placeholder="example.md" pattern=".*\.(md|txt)$">
                <small style="color: var(--text-muted); font-size: 12px;">Must end with .md or .txt</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideNewFileModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- New Skill Modal -->
<div id="newSkillModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 640px;">
        <h3>New Skill</h3>
        <form id="newSkillForm" onsubmit="submitNewSkill(event)">
            <div class="form-group">
                <label>Skill Name *</label>
                <input type="text" id="newSkillName" required placeholder="my_skill" pattern="[a-z0-9_]+">
                <small style="color: var(--text-muted); font-size: 12px;">Lowercase letters, numbers, and underscores only</small>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <input type="text" id="newSkillDescription" required placeholder="What does this skill do?">
            </div>
            <div class="form-group">
                <label>Model</label>
                <select id="newSkillModel">
                    <option value="agentchat">agentchat</option>
                    <option value="skillsrunner">skillsrunner</option>
                    <option value="skillsrunner_deep">skillsrunner_deep</option>
                </select>
            </div>
            <div class="form-group">
                <label>Max Turns</label>
                <input type="number" id="newSkillMaxTurns" value="10" min="1" max="30">
            </div>
            <div class="form-group">
                <label>Tools</label>
                <div id="newSkillToolsGrid" class="tools-checkboxes" style="margin-top: 4px;"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideNewSkillModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- SECTION_SEPARATOR -->
.tab-bar { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 24px; }
.tab { padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-content { display: none; }
.tab-content.active { display: block; }
.detail-grid { display: grid; grid-template-columns: 160px 1fr; gap: 8px 16px; font-size: 14px; }
.detail-label { font-weight: 500; color: var(--text-muted); }
.detail-value { color: var(--text); }
.config-pre { background: var(--bg); padding: 12px; border-radius: 4px; font-family: monospace; font-size: 13px; white-space: pre-wrap; overflow-x: auto; max-height: 200px; }
.member-row { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.member-row:last-child { border-bottom: none; }
.perm-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
.perm-row:last-child { border-bottom: none; }
.toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e2e8f0; transition: 0.2s; border-radius: 24px; }
.toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.2s; border-radius: 50%; }
input:checked + .toggle-slider { background-color: var(--success); }
input:checked + .toggle-slider:before { transform: translateX(20px); }
.ws-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.ws-row:last-child { border-bottom: none; }
.ws-name { font-weight: 500; }
.ws-url { font-size: 12px; color: var(--text-muted); font-family: monospace; }
.conv-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.conv-table th { text-align: left; padding: 8px; border-bottom: 2px solid var(--border); font-weight: 500; color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
.conv-table td { padding: 8px; border-bottom: 1px solid var(--border); }
.token-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.token-row:last-child { border-bottom: none; }
.mcp-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.mcp-row:last-child { border-bottom: none; }
.cred-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.cred-row:last-child { border-bottom: none; }
.meta-tag { display: inline-block; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px; }
.empty-state { padding: 24px; text-align: center; color: var(--text-muted); font-size: 14px; }
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: var(--bg-card); padding: 24px; border-radius: 8px; width: 100%; max-width: 480px; }
.modal-content h3 { margin: 0 0 16px 0; }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--bg); color: var(--text); box-sizing: border-box; }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
.file-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.file-row:last-child { border-bottom: none; }
.file-row:hover { background: var(--bg); }
.file-row.active { background: var(--bg); border-left: 3px solid var(--primary); padding-left: 9px; }
.file-editor { margin-top: 24px; border-top: 2px solid var(--border); padding-top: 16px; }
.file-editor textarea { width: 100%; min-height: 400px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; resize: vertical; }
.file-meta { font-size: 12px; color: var(--text-muted); margin-left: 8px; }
.skill-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.skill-row:last-child { border-bottom: none; }
.skill-row:hover { background: var(--bg); }
.skill-row.active { background: var(--bg); border-left: 3px solid var(--primary); padding-left: 9px; }
.skill-editor { margin-top: 24px; border-top: 2px solid var(--border); padding-top: 16px; }
.skill-editor .frontmatter-section { background: var(--bg); padding: 16px; border-radius: 6px; margin-bottom: 16px; }
.skill-editor .frontmatter-section h4 { margin: 0 0 12px 0; font-size: 14px; font-weight: 600; }
.skill-editor textarea { width: 100%; min-height: 300px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; resize: vertical; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 500; margin-left: 4px; }
.badge-info { background: #dbeafe; color: #1e40af; }
.badge-success { background: #d1fae5; color: #065f46; }
.badge-warning { background: #fef3c7; color: #92400e; }
.badge-danger { background: #fee2e2; color: #991b1b; }
.badge-error { background: #fee2e2; color: #991b1b; }
.tools-checkboxes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.tools-checkboxes label { display: flex; align-items: center; gap: 6px; font-size: 13px; }
.tools-checkboxes input[type="checkbox"] { width: auto; padding: 0; margin: 0; }
.global-skill-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.global-skill-row:last-child { border-bottom: none; }
.global-skill-row.has-override { opacity: 0.7; }

<!-- SECTION_SEPARATOR -->
const CONTEXT_ID = '__CONTEXT_ID__';
const loadedTabs = {};

function formatRelativeTime(isoString) {
    if (!isoString) return 'Never';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' min' + (diffMins > 1 ? 's' : '') + ' ago';
    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
    if (diffDays < 7) return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
    return date.toLocaleDateString();
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => { t.style.display = 'none'; t.classList.remove('active'); });
    document.querySelector('[data-tab="' + tab + '"]').classList.add('active');
    const content = document.getElementById('tab-' + tab);
    content.style.display = 'block';
    content.classList.add('active');
    window.location.hash = tab;
    if (!loadedTabs[tab]) {
        loadedTabs[tab] = true;
        if (tab === 'overview') loadOverview();
        else if (tab === 'permissions') loadPermissions();
        else if (tab === 'credentials') loadCredentials();
        else if (tab === 'workspaces') loadWorkspaces();
        else if (tab === 'mcp') loadMcpServers();
        else if (tab === 'scheduler') loadScheduler();
        else if (tab === 'files') loadFiles();
        else if (tab === 'skills') loadSkills();
    }
}

// --- Overview Tab ---
async function loadOverview() {
    const card = document.getElementById('overviewCard');
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID);
    if (!res) { card.innerHTML = '<div class="empty-state">Failed to load</div>'; return; }
    const ctx = await res.json();

    document.getElementById('contextTitle').textContent = ctx.display_name || ctx.name;
    document.getElementById('contextId').textContent = CONTEXT_ID;
    const typeEl = document.getElementById('contextType');
    typeEl.textContent = ctx.type;
    typeEl.className = 'badge badge-info';

    window._isPersonal = ctx.is_personal || false;
    window._isSystem = ctx.type === 'system';
    window._contextData = ctx;

    // Show SYSTEM badge next to the context title
    if (window._isSystem) {
        const sysBadge = document.createElement('span');
        sysBadge.className = 'badge';
        sysBadge.textContent = 'SYSTEM';
        sysBadge.style.cssText = 'background:#d1d5db;color:#374151;font-size:10px;letter-spacing:0.05em;margin-left:8px;';
        document.getElementById('contextTitle').after(sysBadge);
    }

    let html = '<div class="card-header"><span class="card-title">Context Details</span>';
    html += '<button class="btn btn-sm" onclick="showEditContextModal()">Edit</button></div>';
    html += '<div class="detail-grid">';
    html += '<div class="detail-label">ID</div><div class="detail-value" style="font-family: monospace; font-size: 12px;">' + CONTEXT_ID + '</div>';
    html += '<div class="detail-label">Display Name</div><div class="detail-value">' + escapeHtml(ctx.display_name || '-') + '</div>';
    html += '<div class="detail-label">Name</div><div class="detail-value">' + escapeHtml(ctx.name) + '</div>';
    html += '<div class="detail-label">Type</div><div class="detail-value">' + escapeHtml(ctx.type) + '</div>';
    html += '<div class="detail-label">Default CWD</div><div class="detail-value" style="font-family: monospace;">' + escapeHtml(ctx.default_cwd) + '</div>';
    if (ctx.pinned_files && ctx.pinned_files.length > 0) {
        html += '<div class="detail-label">Pinned Files</div><div class="detail-value">' +
            ctx.pinned_files.map(function(f) {
                var fileName = f.split('/').pop();
                return '<span class="meta-tag">' + escapeHtml(fileName) + '</span>';
            }).join(' ') + '</div>';
    }
    if (ctx.config && Object.keys(ctx.config).length > 0) {
        var internalKeys = ['owner_email', 'created_by'];
        var configEntries = Object.entries(ctx.config).filter(function(entry) {
            return internalKeys.indexOf(entry[0]) === -1;
        });
        if (configEntries.length > 0) {
            html += '<div class="detail-label">Config</div><div class="detail-value">';
            configEntries.forEach(function(entry) {
                var val = typeof entry[1] === 'object' ? JSON.stringify(entry[1]) : String(entry[1]);
                html += '<div><span style="font-weight: 500;">' + escapeHtml(entry[0]) + ':</span> <span>' + escapeHtml(val) + '</span></div>';
            });
            html += '</div>';
        }
    }
    html += '</div>';

    // Load members for all context types
    const membersRes = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/members');
    if (membersRes) {
        const membersData = await membersRes.json();
        html += '<div style="margin-top: 24px;"><div class="card-header"><span class="card-title">Members (' + membersData.total + ')</span>';
        if (!window._isPersonal) {
            html += '<button class="btn btn-sm btn-primary" onclick="showAddMemberModal()">+ Add Member</button>';
        }
        html += '</div>';
        if (membersData.members.length === 0) {
            html += '<div class="empty-state">No members linked to this context</div>';
        } else {
            html += membersData.members.map(function(m) {
                var roleHtml = '';
                if (window._isPersonal) {
                    roleHtml = '<span class="badge badge-info">' + escapeHtml(m.role) + '</span>';
                } else {
                    roleHtml = '<select onchange="updateMemberRole(\'' + m.user_id + '\', this.value)" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">' +
                        '<option value="owner"' + (m.role === 'owner' ? ' selected' : '') + '>Owner</option>' +
                        '<option value="member"' + (m.role === 'member' ? ' selected' : '') + '>Member</option>' +
                        '<option value="viewer"' + (m.role === 'viewer' ? ' selected' : '') + '>Viewer</option>' +
                        '</select>';
                }

                return '<div class="member-row">' +
                    '<span>' + escapeHtml(m.display_name) + ' (' + escapeHtml(m.email) + ')</span>' +
                    '<div style="display: flex; gap: 8px; align-items: center;">' +
                    roleHtml +
                    (m.is_default ? '<span class="badge badge-success">default</span>' : '') +
                    (window._isPersonal ? '' : '<button class="btn btn-sm btn-danger" onclick="removeMember(\'' + m.user_id + '\', \'' + escapeHtml(m.display_name) + '\')">Remove</button>') +
                    '</div></div>';
            }).join('');
        }
        html += '</div>';
    }

    // Conversations section (collapsible)
    const convs = ctx.conversations || [];
    if (convs.length > 0) {
        html += '<div style="margin-top: 24px;">';
        html += '<details><summary style="cursor: pointer; font-weight: 600; font-size: 15px; margin-bottom: 12px;">Conversations (' + convs.length + ')</summary>';
        html += '<table class="conv-table" style="width: 100%; font-size: 13px;"><thead><tr>' +
            '<th style="text-align: left;">ID</th>' +
            '<th style="text-align: left;">Activity</th>' +
            '<th style="text-align: left;">Last Message</th>' +
            '<th style="text-align: center;">Messages</th>' +
            '<th style="text-align: center;">Status</th>' +
            '<th style="text-align: center;">Actions</th>' +
            '</tr></thead><tbody>';

        html += convs.map(function(c) {
            const convId = c.id.substring(0, 8);
            const platform = escapeHtml(c.platform);
            const messageCount = c.message_count || 0;
            const lastActivity = c.last_activity ? formatRelativeTime(c.last_activity) : 'No activity';
            const lastMessage = c.last_user_message ? escapeHtml(c.last_user_message) : '<em style="color: var(--text-muted);">No messages</em>';
            const errorCount = c.error_count || 0;

            // Status badge
            let statusBadge = '';
            if (errorCount > 0) {
                statusBadge = '<span style="background: var(--error); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">' + errorCount + ' error' + (errorCount > 1 ? 's' : '') + '</span>';
            } else if (messageCount > 0) {
                statusBadge = '<span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">OK</span>';
            } else {
                statusBadge = '<span style="color: var(--text-muted); font-size: 11px;">Empty</span>';
            }

            // Actions - link to diagnostics page with trace parameter for auto-search
            let actions = '';
            if (c.last_trace_id) {
                const shortTraceId = c.last_trace_id.substring(0, 8);
                actions = '<a href="/platformadmin/diagnostics/?trace=' + c.last_trace_id + '" title="View trace in diagnostics: ' + c.last_trace_id + '" style="color: var(--primary); text-decoration: none; font-size: 12px; font-family: monospace;">' + shortTraceId + '</a>';
            } else {
                actions = '<span style="color: var(--text-muted); font-size: 11px;">-</span>';
            }

            return '<tr style="border-top: 1px solid var(--border-color);">' +
                '<td style="padding: 12px 8px; font-family: monospace; font-size: 11px;">' +
                    '<div>' + convId + '...</div>' +
                    '<div style="color: var(--text-muted); font-size: 10px; margin-top: 2px;">' + platform + '</div>' +
                '</td>' +
                '<td style="padding: 12px 8px;">' +
                    '<div style="font-weight: 500;">' + lastActivity + '</div>' +
                    '<div style="color: var(--text-muted); font-size: 11px; margin-top: 2px;">Created: ' + (c.created_at ? new Date(c.created_at).toLocaleDateString() : '-') + '</div>' +
                '</td>' +
                '<td style="padding: 12px 8px; max-width: 300px;">' +
                    '<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + lastMessage + '</div>' +
                '</td>' +
                '<td style="padding: 12px 8px; text-align: center; font-weight: 600;">' + messageCount + '</td>' +
                '<td style="padding: 12px 8px; text-align: center;">' + statusBadge + '</td>' +
                '<td style="padding: 12px 8px; text-align: center;">' + actions + '</td>' +
                '</tr>';
        }).join('');
        html += '</tbody></table></details></div>';
    }

    // Danger Zone (not for personal or system contexts)
    if (!window._isPersonal && !window._isSystem) {
        html += '<div style="margin-top: 32px; border: 1px solid var(--error); border-radius: 8px; padding: 16px;">';
        html += '<h3 style="color: var(--error); margin: 0 0 8px 0; font-size: 15px;">Danger Zone</h3>';
        html += '<p style="font-size: 13px; color: var(--text-muted); margin: 0 0 12px 0;">Deleting this context will permanently remove all conversations, credentials, workspaces, scheduled jobs, and files associated with it.</p>';
        html += '<button class="btn btn-sm btn-danger" onclick="deleteContext()">Delete Context</button>';
        html += '</div>';
    }

    card.innerHTML = html;
}

async function deleteContext() {
    if (!confirm('Are you sure you want to delete this context? This will permanently remove ALL associated data (conversations, credentials, files, skills, workspaces, scheduled jobs). This CANNOT be undone.')) return;
    var ctxName = (window._contextData && window._contextData.display_name) || (window._contextData && window._contextData.name) || 'this context';
    if (!confirm('Really delete "' + ctxName + '"? Type DELETE to confirm (this is irreversible).')) return;

    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID, { method: 'DELETE' });
    if (res) {
        showToast('Context deleted', 'success');
        window.location.href = '/platformadmin/contexts/';
    }
}

function showEditContextModal() {
    const ctx = window._contextData;
    if (!ctx) return;
    document.getElementById('editCtxDisplayName').value = ctx.display_name || '';
    document.getElementById('editCtxName').value = ctx.name;
    document.getElementById('editCtxType').value = ctx.type;
    document.getElementById('editCtxCwd').value = ctx.default_cwd;
    document.getElementById('editCtxMemoryFile').value = (ctx.config && ctx.config.memory_file) || 'memory.md';
    document.getElementById('editContextModal').style.display = 'flex';
}
function hideEditContextModal() { document.getElementById('editContextModal').style.display = 'none'; }

async function submitEditContext(e) {
    e.preventDefault();
    const body = {
        display_name: document.getElementById('editCtxDisplayName').value || null,
        name: document.getElementById('editCtxName').value,
        type: document.getElementById('editCtxType').value,
        default_cwd: document.getElementById('editCtxCwd').value,
        memory_file: document.getElementById('editCtxMemoryFile').value || 'memory.md'
    };
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    if (res) {
        showToast('Context updated', 'success');
        hideEditContextModal();
        loadedTabs['overview'] = false;
        loadOverview();
    }
}

function showAddMemberModal() { document.getElementById('addMemberModal').style.display = 'flex'; }
function hideAddMemberModal() { document.getElementById('addMemberModal').style.display = 'none'; document.getElementById('addMemberForm').reset(); }

async function submitAddMember(e) {
    e.preventDefault();
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/members', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            email: document.getElementById('memberEmail').value,
            role: document.getElementById('memberRole').value
        })
    });
    if (res) {
        showToast('Member added', 'success');
        hideAddMemberModal();
        loadedTabs['overview'] = false;
        loadOverview();
    }
}

async function updateMemberRole(userId, role) {
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/members/' + userId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: role })
    });
    if (res) { showToast('Role updated', 'success'); }
}

async function removeMember(userId, name) {
    if (!confirm('Remove ' + name + ' from this context?')) return;
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/members/' + userId, { method: 'DELETE' });
    if (res) {
        showToast('Member removed', 'success');
        loadedTabs['overview'] = false;
        loadOverview();
    }
}

// --- Permissions Tab ---
async function loadPermissions() {
    const card = document.getElementById('permissionsCard');
    const res = await fetchWithErrorHandling('/platformadmin/permissions/contexts/' + CONTEXT_ID);
    if (!res) { card.innerHTML = '<div class="empty-state">Failed to load permissions</div>'; return; }
    const data = await res.json();
    const tools = data.tools || [];

    let html = '<div class="card-header"><span class="card-title">Tool Permissions (' + tools.length + ')</span>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<button class="btn btn-sm" onclick="bulkPermissions(true)">Allow All</button>';
    html += '<button class="btn btn-sm" onclick="bulkPermissions(false)">Deny All</button>';
    html += '</div></div>';

    if (tools.length === 0) {
        html += '<div class="empty-state">No tools configured</div>';
    } else {
        html += tools.map(t =>
            '<div class="perm-row">' +
            '<div><span style="font-weight: 500;">' + escapeHtml(t.tool_name) + '</span>' +
            (t.description ? '<div style="font-size: 12px; color: var(--text-muted);">' + escapeHtml(t.description) + '</div>' : '') +
            '</div>' +
            '<label class="toggle-switch">' +
            '<input type="checkbox" ' + (t.allowed !== false ? 'checked' : '') + ' onchange="togglePermission(\'' + t.tool_name + '\', this.checked)">' +
            '<span class="toggle-slider"></span></label></div>'
        ).join('');
    }
    card.innerHTML = html;
}

async function togglePermission(toolName, allowed) {
    const res = await fetchWithErrorHandling('/platformadmin/permissions/contexts/' + CONTEXT_ID + '/tools/' + toolName, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ allowed: allowed })
    });
    if (res) {
        showToast(toolName + (allowed ? ' allowed' : ' denied'), 'success');
    } else {
        showToast('Failed to update ' + toolName, 'error');
        // Revert toggle on error
        loadedTabs['permissions'] = false;
        loadPermissions();
    }
}

async function bulkPermissions(allowed) {
    const action = allowed ? 'allow_all' : 'deny_all';
    const payload = { action: action };
    const res = await fetchWithErrorHandling('/platformadmin/permissions/contexts/' + CONTEXT_ID + '/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    if (res) {
        showToast(allowed ? 'All tools allowed' : 'All tools denied', 'success');
        loadedTabs['permissions'] = false;
        loadPermissions();
    } else {
        showToast('Failed to update permissions', 'error');
    }
}

// --- Credentials Tab ---
async function loadCredentials() {
    const card = document.getElementById('credentialsCard');
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/credentials');
    if (!res) { card.innerHTML = '<div class="empty-state">Failed to load credentials</div>'; return; }
    const data = await res.json();
    const creds = data.credentials || [];

    let html = '<div class="card-header"><span class="card-title">Credentials (' + creds.length + ')</span>';
    html += '<button class="btn btn-sm btn-primary" onclick="showCredModal()">+ Add Credential</button>';
    html += '</div>';

    if (creds.length === 0) {
        html += '<div class="empty-state">No credentials configured for this context</div>';
    } else {
        html += creds.map(c => {
            const meta = Object.entries(c.metadata || {})
                .map(function(entry) { return '<span class="meta-tag">' + escapeHtml(entry[0]) + ': ' + escapeHtml(entry[1]) + '</span>'; })
                .join('') || '-';
            const typeName = c.credential_type === 'azure_devops_pat' ? 'Azure DevOps PAT' : c.credential_type;
            return '<div class="cred-row"><div>' +
                '<div style="font-weight: 500;">' + escapeHtml(typeName) + '</div>' +
                '<div style="font-size: 12px; color: var(--text-muted);">' + meta + '</div>' +
                '<div style="font-size: 11px; color: var(--text-muted);">Updated: ' + (c.updated_at ? new Date(c.updated_at).toLocaleString() : '-') + '</div>' +
                '</div><div>' +
                '<button class="btn btn-sm btn-danger" onclick="deleteCredential(\'' + c.id + '\', \'' + escapeHtml(c.credential_type) + '\')">Delete</button>' +
                '</div></div>';
        }).join('');
    }

    // After credentials section, add OAuth tokens
    const oauthRes = await fetchWithErrorHandling('/platformadmin/oauth/tokens?context_id=' + CONTEXT_ID);
    if (oauthRes) {
        const oauthData = await oauthRes.json();
        const tokens = oauthData.tokens || [];
        html += '<div style="margin-top: 24px; border-top: 2px solid var(--border); padding-top: 16px;">';
        html += '<div class="card-header"><span class="card-title">OAuth Tokens (' + tokens.length + ')</span>';
        html += '<a href="/platformadmin/oauth/initiate/homey?context_id=' + CONTEXT_ID + '" class="btn btn-sm btn-primary" target="_blank">Authorize Homey</a>';
        html += '</div>';
        if (tokens.length === 0) {
            html += '<div class="empty-state">No OAuth tokens for this context</div>';
        } else {
            html += tokens.map(function(t) {
                var statusText = t.is_expired ? (t.has_refresh_token ? 'Auto-refreshes' : 'Expired') : 'Valid';
                var statusColor = t.is_expired && !t.has_refresh_token ? 'var(--error)' : 'var(--success)';
                return '<div class="token-row"><div>' +
                    '<div style="font-weight: 500;">' + escapeHtml(t.provider) + '</div>' +
                    '<div style="font-size: 12px; color: var(--text-muted);">Type: ' + t.token_type +
                    ' | ' + (t.has_refresh_token ? 'Last refreshed: ' + (t.updated_at ? new Date(t.updated_at).toLocaleString() : 'N/A') : 'Expires: ' + (t.expires_at || 'N/A')) +
                    ' | <span style="color: ' + statusColor + ';">' + statusText + '</span></div>' +
                    (t.scope ? '<div style="font-size: 11px; color: var(--text-muted);">Scope: ' + escapeHtml(t.scope) + '</div>' : '') +
                    '</div><div>' +
                    '<button class="btn btn-sm btn-danger" onclick="revokeOAuthToken(\'' + t.id + '\')">Revoke</button>' +
                    '</div></div>';
            }).join('');
        }
        html += '</div>';
    }

    card.innerHTML = html;
}

function showCredModal() { document.getElementById('addCredModal').style.display = 'flex'; }
function hideCredModal() { document.getElementById('addCredModal').style.display = 'none'; document.getElementById('addCredForm').reset(); }

async function submitCredential(e) {
    e.preventDefault();
    const value = document.getElementById('credValue').value;
    const orgUrl = document.getElementById('credOrgUrl').value;

    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/credentials', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            credential_type: 'azure_devops_pat',
            value: value,
            metadata: { organization_url: orgUrl }
        })
    });
    if (res) {
        showToast('Credential saved', 'success');
        hideCredModal();
        loadedTabs['credentials'] = false;
        loadCredentials();
    }
}

async function deleteCredential(credId, credType) {
    if (!confirm('Delete this ' + credType + ' credential? This cannot be undone.')) return;
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/credentials/' + credId, { method: 'DELETE' });
    if (res) {
        showToast('Credential deleted', 'success');
        loadedTabs['credentials'] = false;
        loadCredentials();
    }
}

async function revokeOAuthToken(id) {
    if (!confirm('Revoke this OAuth token?')) return;
    await fetchWithErrorHandling('/platformadmin/oauth/tokens/' + id, { method: 'DELETE' });
    loadedTabs['credentials'] = false;
    loadCredentials();
}

// --- Workspaces Tab ---
async function loadWorkspaces() {
    const card = document.getElementById('workspacesCard');
    const res = await fetchWithErrorHandling('/platformadmin/workspaces/list?context_id=' + CONTEXT_ID);
    if (!res) { card.innerHTML = '<div class="empty-state">Failed to load workspaces</div>'; return; }
    const data = await res.json();
    const workspaces = data.workspaces || [];

    let html = '<div class="card-header"><span class="card-title">Workspaces (' + workspaces.length + ')</span>';
    html += '<button class="btn btn-sm btn-primary" onclick="showWorkspaceModal()">+ Clone Repository</button></div>';

    if (workspaces.length === 0) {
        html += '<div class="empty-state">No workspaces configured for this context</div>';
    } else {
        html += workspaces.map(function(w) {
            return '<div class="ws-row"><div>' +
                '<div class="ws-name">' + escapeHtml(w.name || w.repo_url.split('/').pop()) + '</div>' +
                '<div class="ws-url">' + escapeHtml(w.repo_url) + '</div>' +
                '<div style="font-size: 11px; color: var(--text-muted);">Status: <span class="badge badge-' + (w.status === 'cloned' ? 'success' : w.status === 'error' ? 'error' : 'info') + '">' + w.status + '</span>' +
                (w.last_synced_at ? ' | Last synced: ' + new Date(w.last_synced_at).toLocaleString() : '') +
                (w.sync_error ? ' | <span style="color: var(--error);">' + escapeHtml(w.sync_error) + '</span>' : '') +
                '</div>' +
                '</div><div style="display: flex; gap: 8px;">' +
                '<button class="btn btn-sm" onclick="syncWorkspace(\'' + w.id + '\')">Sync</button>' +
                '<button class="btn btn-sm btn-danger" onclick="deleteWorkspace(\'' + w.id + '\')">Delete</button>' +
                '</div></div>';
        }).join('');
    }
    card.innerHTML = html;
}

async function syncWorkspace(id) {
    await fetchWithErrorHandling('/platformadmin/workspaces/' + id + '/sync', { method: 'POST' });
    showToast('Sync started', 'success');
}

async function deleteWorkspace(id) {
    if (!confirm('Delete this workspace?')) return;
    await fetchWithErrorHandling('/platformadmin/workspaces/' + id, { method: 'DELETE' });
    loadedTabs['workspaces'] = false;
    loadWorkspaces();
}

function showWorkspaceModal() { document.getElementById('addWorkspaceModal').style.display = 'flex'; }
function hideWorkspaceModal() { document.getElementById('addWorkspaceModal').style.display = 'none'; document.getElementById('addWorkspaceForm').reset(); }

async function submitAddWorkspace(e) {
    e.preventDefault();
    const body = {
        context_id: CONTEXT_ID,
        repo_url: document.getElementById('wsRepoUrl').value,
        name: document.getElementById('wsName').value || null,
        branch: document.getElementById('wsBranch').value || null
    };
    const res = await fetchWithErrorHandling('/platformadmin/workspaces', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    if (res) {
        showToast('Repository cloned', 'success');
        hideWorkspaceModal();
        loadedTabs['workspaces'] = false;
        loadWorkspaces();
    }
}

// --- MCP Servers Tab ---
async function loadMcpServers() {
    const card = document.getElementById('mcpCard');
    const res = await fetchWithErrorHandling('/platformadmin/mcp/servers?context_id=' + CONTEXT_ID);
    if (!res) { card.innerHTML = '<div class="empty-state">Failed to load MCP servers</div>'; return; }
    const data = await res.json();
    const servers = data.servers || [];

    let html = '<div class="card-header"><span class="card-title">MCP Servers (' + servers.length + ')</span>';
    html += '<button class="btn btn-sm btn-primary" onclick="showMcpModal()">+ Add Server</button></div>';

    if (servers.length === 0) {
        html += '<div class="empty-state">No MCP servers configured for this context</div>';
    } else {
        html += servers.map(function(s) {
            var oauthBtn = '';
            if (s.auth_type === 'oauth' && s.has_oauth_config) {
                oauthBtn = '<button class="btn btn-sm" onclick="startMcpOAuth(\'' + s.id + '\')">Authorize</button>';
            }
            return '<div class="mcp-row"><div>' +
                '<div style="font-weight: 500;">' + escapeHtml(s.name) + (s.is_enabled ? '' : ' <span class="badge badge-info">disabled</span>') + '</div>' +
                '<div style="font-size: 12px; color: var(--text-muted); font-family: monospace;">' + escapeHtml(s.url) + '</div>' +
                '<div style="font-size: 11px; margin-top: 4px;">Status: <span class="badge badge-' + (s.status === 'connected' ? 'success' : s.status === 'error' ? 'error' : 'info') + '">' + s.status + '</span>' +
                ' | Transport: ' + s.transport + ' | Auth: ' + s.auth_type +
                (s.tools_count > 0 ? ' | Tools: ' + s.tools_count : '') +
                (s.last_error ? '<div style="color: var(--error); font-size: 11px; margin-top: 2px;">Error: ' + escapeHtml(s.last_error) + '</div>' : '') +
                '</div>' +
                '</div><div style="display: flex; gap: 4px;">' +
                oauthBtn +
                '<button class="btn btn-sm" onclick="testMcpServer(\'' + s.id + '\')">Test</button>' +
                '<button class="btn btn-sm" onclick="editMcpServer(\'' + s.id + '\', ' + escapeHtml(JSON.stringify(JSON.stringify(s))) + ')">Edit</button>' +
                '<button class="btn btn-sm btn-danger" onclick="deleteMcpServer(\'' + s.id + '\', \'' + escapeHtml(s.name) + '\')">Delete</button>' +
                '</div></div>';
        }).join('');
    }
    card.innerHTML = html;
}

async function testMcpServer(id) {
    const res = await fetchWithErrorHandling('/platformadmin/mcp/servers/' + id + '/test', { method: 'POST' });
    if (res) {
        const data = await res.json();
        showToast(data.status === 'connected' ? 'Connection successful' : 'Connection failed: ' + (data.error || 'unknown'), data.status === 'connected' ? 'success' : 'error');
        loadedTabs['mcp'] = false;
        loadMcpServers();
    }
}

function showMcpModal(editData) {
    document.getElementById('mcpEditId').value = '';
    document.getElementById('mcpModalTitle').textContent = 'Add MCP Server';
    document.getElementById('addMcpForm').reset();
    toggleMcpAuthFields();
    document.getElementById('addMcpModal').style.display = 'flex';
}
function hideMcpModal() { document.getElementById('addMcpModal').style.display = 'none'; document.getElementById('addMcpForm').reset(); toggleMcpAuthFields(); }

function toggleMcpAuthFields() {
    var authType = document.getElementById('mcpAuthType').value;
    document.getElementById('mcpBearerFields').style.display = authType === 'bearer' ? 'block' : 'none';
    document.getElementById('mcpOAuthFields').style.display = authType === 'oauth' ? 'block' : 'none';
}

function editMcpServer(id, jsonStr) {
    var s = JSON.parse(jsonStr);
    document.getElementById('mcpEditId').value = id;
    document.getElementById('mcpModalTitle').textContent = 'Edit MCP Server';
    document.getElementById('mcpName').value = s.name || '';
    document.getElementById('mcpUrl').value = s.url || '';
    document.getElementById('mcpTransport').value = s.transport || 'auto';
    document.getElementById('mcpAuthType').value = s.auth_type || 'none';
    toggleMcpAuthFields();
    document.getElementById('addMcpModal').style.display = 'flex';
}

async function submitMcpServer(e) {
    e.preventDefault();
    var editId = document.getElementById('mcpEditId').value;
    var authType = document.getElementById('mcpAuthType').value;
    var body = {
        name: document.getElementById('mcpName').value,
        url: document.getElementById('mcpUrl').value,
        transport: document.getElementById('mcpTransport').value,
        auth_type: authType
    };
    if (authType === 'bearer') {
        var token = document.getElementById('mcpAuthToken').value;
        if (token) body.auth_token = token;
    }
    if (authType === 'oauth') {
        body.oauth_authorize_url = document.getElementById('mcpOAuthAuthUrl').value || null;
        body.oauth_token_url = document.getElementById('mcpOAuthTokenUrl').value || null;
        body.oauth_client_id = document.getElementById('mcpOAuthClientId').value || null;
        var secret = document.getElementById('mcpOAuthClientSecret').value;
        if (secret) body.oauth_client_secret = secret;
        body.oauth_scopes = document.getElementById('mcpOAuthScopes').value || null;
    }

    var url, method;
    if (editId) {
        url = '/platformadmin/mcp/servers/' + editId;
        method = 'PUT';
    } else {
        body.context_id = CONTEXT_ID;
        url = '/platformadmin/mcp/servers';
        method = 'POST';
    }

    var res = await fetchWithErrorHandling(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    if (res) {
        showToast(editId ? 'Server updated' : 'Server added', 'success');
        hideMcpModal();
        loadedTabs['mcp'] = false;
        loadMcpServers();
    }
}

async function deleteMcpServer(id, name) {
    if (!confirm('Delete MCP server "' + name + '"?')) return;
    var res = await fetchWithErrorHandling('/platformadmin/mcp/servers/' + id, { method: 'DELETE' });
    if (res) {
        showToast('Server deleted', 'success');
        loadedTabs['mcp'] = false;
        loadMcpServers();
    }
}

async function startMcpOAuth(serverId) {
    var res = await fetchWithErrorHandling('/platformadmin/mcp/servers/' + serverId + '/oauth/start', { method: 'POST' });
    if (res) {
        var data = await res.json();
        if (data.authorization_url) {
            window.open(data.authorization_url, '_blank');
            showToast('OAuth authorization started - complete in the new window', 'success');
        }
    }
}

// --- Scheduler Tab ---
async function loadScheduler() {
    const card = document.getElementById('schedulerCard');
    const res = await fetchWithErrorHandling('/platformadmin/scheduler/context/' + CONTEXT_ID + '/jobs');
    if (!res) { card.innerHTML = '<div class="empty-state">Failed to load scheduler data</div>'; return; }
    const data = await res.json();
    const jobs = data.jobs || [];

    let html = '<div class="card-header"><span class="card-title">Scheduled Jobs (' + jobs.length + ')</span>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<button class="btn btn-primary btn-sm" onclick="showJobModal()">+ Create Job</button>';
    html += '<button class="btn btn-sm" onclick="showHeartbeatModal()">+ Create Heartbeat</button>';
    html += '</div></div>';

    if (jobs.length === 0) {
        html += '<div class="empty-state">No scheduled jobs for this context</div>';
    } else {
        jobs.forEach(function(j) {
            const statusClass = j.status === 'active' ? 'badge-success' :
                               j.status === 'error' ? 'badge-danger' :
                               j.status === 'running' ? 'badge-warning' : 'badge-info';
            const nextRun = j.next_run_at ? new Date(j.next_run_at).toLocaleString() : 'N/A';
            const lastRun = j.last_run_at ? new Date(j.last_run_at).toLocaleString() : 'Never';
            const lastStatus = j.last_run_status || 'N/A';

            html += '<div class="cred-row" style="flex-direction: column; align-items: flex-start;">';
            html += '<div style="display:flex;justify-content:space-between;width:100%;align-items:center;">';
            html += '<div><strong>' + escapeHtml(j.name) + '</strong> <span class="badge ' + statusClass + '">' + j.status + '</span></div>';
            html += '<div style="display:flex;gap:4px;">';
            html += '<button class="btn btn-sm" onclick="toggleJob(\'' + j.id + '\')" title="' + (j.is_enabled ? 'Pause' : 'Enable') + '">' + (j.is_enabled ? 'Pause' : 'Enable') + '</button>';
            html += '<button class="btn btn-sm btn-primary" onclick="runJobNow(\'' + j.id + '\')" ' + (j.is_enabled ? '' : 'disabled') + '>Run Now</button>';
            html += '<button class="btn btn-sm" onclick="editJob(' + JSON.stringify(j) + ')">Edit</button>';
            html += '<button class="btn btn-sm btn-danger" onclick="deleteJob(\'' + j.id + '\', \'' + escapeHtml(j.name) + '\')">Delete</button>';
            html += '</div></div>';
            html += '<div class="job-meta" style="margin-top: 8px; font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; flex-wrap: wrap;">';
            html += '<span>Cron: <code>' + escapeHtml(j.cron_expression) + '</code></span>';
            html += '<span>Next: ' + nextRun + '</span>';
            html += '<span>Last: ' + lastRun + ' (' + lastStatus + ')</span>';
            html += '<span>Runs: ' + j.run_count + '</span>';
            if (j.error_count > 0) html += '<span style="color: var(--error);">Errors: ' + j.error_count + '</span>';
            if (j.notification_channel) html += '<span>Notify: ' + j.notification_channel + '</span>';
            html += '</div>';
            if (j.skill_prompt) {
                var promptPreview = j.skill_prompt.length > 120 ? j.skill_prompt.substring(0, 120) + '...' : j.skill_prompt;
                html += '<div style="margin-top: 4px; font-size: 12px; color: var(--text-muted); font-style: italic;">' + escapeHtml(promptPreview) + '</div>';
            }
            if (j.description) {
                html += '<div style="margin-top: 4px; font-size: 12px; color: var(--text-muted);">' + escapeHtml(j.description) + '</div>';
            }
            if (j.last_run_result) {
                var resultPreview = j.last_run_result.length > 200 ? j.last_run_result.substring(0, 200) + '...' : j.last_run_result;
                html += '<details style="margin-top: 4px; font-size: 12px;">';
                html += '<summary>Last Result (' + j.last_run_result.length + ' chars)</summary>';
                html += '<div style="position: relative;">';
                html += '<pre style="white-space: pre-wrap; max-height: 300px; overflow: auto; background: var(--bg); padding: 12px; border-radius: 4px; margin-top: 4px; font-size: 12px; line-height: 1.5;">' + escapeHtml(j.last_run_result) + '</pre>';
                html += '<button class="btn btn-sm" style="position: absolute; top: 8px; right: 8px; font-size: 11px;" onclick="navigator.clipboard.writeText(' + escapeHtml(JSON.stringify(JSON.stringify(j.last_run_result))) + ');showToast(\'Copied\',\'success\')">Copy</button>';
                html += '</div></details>';
            }
            html += '</div>';
        });
    }
    card.innerHTML = html;
}

function showJobModal() {
    document.getElementById('createJobModal').style.display = 'flex';
}

function showHeartbeatModal() {
    document.getElementById('createJobModal').style.display = 'flex';
    document.getElementById('jobName').value = 'proactive-heartbeat';
    document.getElementById('jobCron').value = '0 */4 * * *';
    document.getElementById('jobDescription').value = 'Proactive background check every 4 hours';
    document.getElementById('jobPrompt').value = `You are running a proactive background check. Read the heartbeat config from _ai-platform/heartbeat.md (via vault tools if available) or use these default tasks:

1. Check if there are new notes in Inbox/ - summarize them
2. Review today's conversations and update memory.md with learnings
3. Report any pending items that need user attention

For any actions that modify data, describe what you would do and request user approval first.`;
    document.getElementById('jobNotifChannel').value = 'telegram';
    document.getElementById('jobTimeout').value = '120';
    toggleNotifTarget();
}

function hideJobModal() {
    document.getElementById('createJobModal').style.display = 'none';
    document.getElementById('createJobForm').reset();
    document.getElementById('notifTargetGroup').style.display = 'none';
    document.getElementById('cronPresets').value = '';
}

function toggleNotifTarget() {
    const ch = document.getElementById('jobNotifChannel').value;
    document.getElementById('notifTargetGroup').style.display = ch ? 'block' : 'none';
}

function applyCronPreset() {
    const preset = document.getElementById('cronPresets').value;
    if (preset) {
        document.getElementById('jobCron').value = preset;
    }
}

async function submitJob(e) {
    e.preventDefault();
    const body = {
        name: document.getElementById('jobName').value,
        skill_prompt: document.getElementById('jobPrompt').value,
        cron_expression: document.getElementById('jobCron').value,
        description: document.getElementById('jobDescription').value || null,
        notification_channel: document.getElementById('jobNotifChannel').value || null,
        notification_target: document.getElementById('jobNotifTarget').value || null,
        timeout_seconds: parseInt(document.getElementById('jobTimeout').value) || 300
    };
    const res = await fetchWithErrorHandling('/platformadmin/scheduler/context/' + CONTEXT_ID + '/jobs', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
    });
    if (res) {
        showToast('Job created', 'success');
        hideJobModal();
        loadedTabs['scheduler'] = false;
        loadScheduler();
    }
}

async function toggleJob(jobId) {
    const res = await fetchWithErrorHandling('/platformadmin/scheduler/jobs/' + jobId + '/toggle', { method: 'POST' });
    if (res) {
        showToast('Job toggled', 'success');
        loadedTabs['scheduler'] = false;
        loadScheduler();
    }
}

async function runJobNow(jobId) {
    const res = await fetchWithErrorHandling('/platformadmin/scheduler/jobs/' + jobId + '/run-now', { method: 'POST' });
    if (res) {
        showToast('Job triggered for immediate execution', 'success');
        loadedTabs['scheduler'] = false;
        loadScheduler();
    }
}

async function deleteJob(jobId, name) {
    if (!confirm('Delete job "' + name + '"? This cannot be undone.')) return;
    const res = await fetchWithErrorHandling('/platformadmin/scheduler/jobs/' + jobId, { method: 'DELETE' });
    if (res) {
        showToast('Job deleted', 'success');
        loadedTabs['scheduler'] = false;
        loadScheduler();
    }
}

function editJob(job) {
    document.getElementById('editJobId').value = job.id;
    document.getElementById('editJobPrompt').value = job.skill_prompt || '';
    document.getElementById('editJobCron').value = job.cron_expression || '';
    document.getElementById('editJobDescription').value = job.description || '';
    document.getElementById('editJobTimeout').value = job.timeout_seconds || 300;
    const notifChan = job.notification_channel || '';
    document.getElementById('editJobNotifChannel').value = notifChan;
    document.getElementById('editJobNotifTarget').value = job.notification_target || '';
    document.getElementById('editNotifTargetGroup').style.display = notifChan ? 'block' : 'none';
    document.getElementById('editCronPresets').value = '';
    document.getElementById('editJobModal').style.display = 'flex';
}

function hideEditJobModal() {
    document.getElementById('editJobModal').style.display = 'none';
}

function applyEditCronPreset() {
    const val = document.getElementById('editCronPresets').value;
    if (val) document.getElementById('editJobCron').value = val;
}

function toggleEditNotifTarget() {
    const chan = document.getElementById('editJobNotifChannel').value;
    document.getElementById('editNotifTargetGroup').style.display = chan ? 'block' : 'none';
}

async function submitEditJob(event) {
    event.preventDefault();
    const jobId = document.getElementById('editJobId').value;
    const body = {
        skill_prompt: document.getElementById('editJobPrompt').value,
        cron_expression: document.getElementById('editJobCron').value,
        description: document.getElementById('editJobDescription').value || null,
        notification_channel: document.getElementById('editJobNotifChannel').value || null,
        notification_target: document.getElementById('editJobNotifTarget').value || null,
        timeout_seconds: parseInt(document.getElementById('editJobTimeout').value) || 300
    };
    const res = await fetchWithErrorHandling('/platformadmin/scheduler/jobs/' + jobId, {
        method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
    });
    if (res) {
        showToast('Job updated', 'success');
        hideEditJobModal();
        loadedTabs['scheduler'] = false;
        loadScheduler();
    }
}

// --- Files Tab ---
let currentFile = null;
let fileListCache = [];

async function loadFiles() {
    const card = document.getElementById('filesCard');
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/files');
    if (!res) { card.innerHTML = '<div class="empty-state">Failed to load files</div>'; return; }
    const data = await res.json();
    fileListCache = data.files || [];

    let html = '<div class="card-header"><span class="card-title">Context Files (' + fileListCache.length + ')</span>';
    html += '<button class="btn btn-sm btn-primary" onclick="showNewFileModal()">+ New File</button>';
    html += '</div>';

    if (fileListCache.length === 0) {
        html += '<div class="empty-state">No files in this context</div>';
    } else {
        html += fileListCache.map(function(f) {
            const sizeKB = (f.size / 1024).toFixed(1);
            const maxSizeKB = 16;
            return '<div class="file-row" id="file-row-' + escapeHtml(f.name) + '" onclick="selectFile(\'' + escapeHtml(f.name) + '\')">' +
                '<div>' +
                '<span style="font-weight: 500;">' + escapeHtml(f.name) + '</span>' +
                '<span class="file-meta">' + sizeKB + ' KB / ' + maxSizeKB + ' KB' + (f.pinned ? ' &bull; pinned' : '') + '</span>' +
                '</div>' +
                '<div style="display: flex; gap: 4px; align-items: center;" onclick="event.stopPropagation();">' +
                '<label class="toggle-switch" title="' + (f.pinned ? 'Unpin file' : 'Pin file') + '">' +
                '<input type="checkbox" ' + (f.pinned ? 'checked' : '') + ' onchange="toggleFilePin(\'' + escapeHtml(f.name) + '\', this.checked)">' +
                '<span class="toggle-slider"></span>' +
                '</label>' +
                '<button class="btn btn-sm btn-danger" onclick="deleteFile(\'' + escapeHtml(f.name) + '\')">Delete</button>' +
                '</div>' +
                '</div>';
        }).join('');
    }

    html += '<div id="fileEditorContainer"></div>';
    card.innerHTML = html;

    if (currentFile) {
        selectFile(currentFile);
    }
}

async function selectFile(fileName) {
    currentFile = fileName;

    document.querySelectorAll('.file-row').forEach(function(row) {
        row.classList.remove('active');
    });
    const rowElement = document.getElementById('file-row-' + fileName);
    if (rowElement) {
        rowElement.classList.add('active');
    }

    const container = document.getElementById('fileEditorContainer');
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/files/' + encodeURIComponent(fileName));
    if (!res) {
        container.innerHTML = '<div class="empty-state">Failed to load file</div>';
        return;
    }
    const data = await res.json();

    let html = '<div class="file-editor">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
    html += '<h4 style="margin: 0;">Editing: ' + escapeHtml(fileName) + '</h4>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<button class="btn btn-sm" onclick="closeEditor()">Close</button>';
    html += '<button class="btn btn-sm btn-primary" onclick="saveFile()">Save</button>';
    html += '</div></div>';
    html += '<textarea id="fileContentEditor">' + escapeHtml(data.content || '') + '</textarea>';
    html += '</div>';

    container.innerHTML = html;
}

function closeEditor() {
    currentFile = null;
    document.getElementById('fileEditorContainer').innerHTML = '';
    document.querySelectorAll('.file-row').forEach(function(row) {
        row.classList.remove('active');
    });
}

async function saveFile() {
    if (!currentFile) return;
    const content = document.getElementById('fileContentEditor').value;
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/files/' + encodeURIComponent(currentFile), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
    });
    if (res) {
        showToast('File saved', 'success');
        loadedTabs['files'] = false;
        loadFiles();
    }
}

async function toggleFilePin(fileName, pinned) {
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/files/' + encodeURIComponent(fileName) + '/pin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pinned: pinned })
    });
    if (res) {
        showToast(pinned ? 'File pinned' : 'File unpinned', 'success');
        loadedTabs['files'] = false;
        loadFiles();
    }
}

async function deleteFile(fileName) {
    if (!confirm('Delete file "' + fileName + '"? This cannot be undone.')) return;
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/files/' + encodeURIComponent(fileName), { method: 'DELETE' });
    if (res) {
        showToast('File deleted', 'success');
        if (currentFile === fileName) {
            currentFile = null;
        }
        loadedTabs['files'] = false;
        loadFiles();
    }
}

function showNewFileModal() {
    document.getElementById('newFileModal').style.display = 'flex';
}

function hideNewFileModal() {
    document.getElementById('newFileModal').style.display = 'none';
    document.getElementById('newFileForm').reset();
}

async function submitNewFile(e) {
    e.preventDefault();
    const fileName = document.getElementById('newFileName').value;

    if (!fileName.endsWith('.md') && !fileName.endsWith('.txt')) {
        showToast('File name must end with .md or .txt', 'error');
        return;
    }

    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/files/' + encodeURIComponent(fileName), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: '' })
    });
    if (res) {
        showToast('File created', 'success');
        hideNewFileModal();
        loadedTabs['files'] = false;
        await loadFiles();
        selectFile(fileName);
    }
}

// --- Skills Tab ---
const AVAILABLE_TOOLS = [
    'web_search', 'web_fetch', 'read_file', 'azure_devops',
    'test_runner', 'price_tracker', 'send_email', 'homey',
    'git_clone', 'claude_code', 'github_pr', 'update_memory', 'tibp_wiki_search'
];

let currentSkill = null;
let skillListCache = [];

async function loadSkills() {
    const card = document.getElementById('skillsCard');

    // Fetch both global and context skills in parallel
    const [globalRes, contextRes] = await Promise.all([
        fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/global-skills'),
        fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/skills')
    ]);

    if (!globalRes && !contextRes) {
        card.innerHTML = '<div class="empty-state">Failed to load skills</div>';
        return;
    }

    const globalData = globalRes ? await globalRes.json() : { skills: [] };
    const contextData = contextRes ? await contextRes.json() : { skills: [] };
    const globalSkills = globalData.skills || [];
    skillListCache = contextData.skills || [];

    // Build context skill name set for override detection
    const contextSkillNames = new Set();
    skillListCache.forEach(function(s) {
        // Use parsed frontmatter name if available, otherwise filename without .md
        const parsedName = s.description !== undefined ? s.name : s.name.replace('.md', '');
        contextSkillNames.add(parsedName);
    });

    let html = '';

    // --- Global Skills Catalog ---
    html += '<div class="card-header"><span class="card-title">Global Skills Catalog (' + globalSkills.length + ')</span>';
    html += '<span style="font-size: 12px; color: var(--text-muted); margin-left: 8px;">Read-only -- repo-managed</span></div>';

    if (globalSkills.length === 0) {
        html += '<div class="empty-state">No global skills loaded</div>';
    } else {
        // Group by category
        const categories = {};
        globalSkills.forEach(function(s) {
            const cat = s.category || 'other';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(s);
        });

        Object.keys(categories).sort().forEach(function(cat) {
            html += '<div style="margin-bottom: 8px;">';
            html += '<div style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; padding: 8px 0 4px 0;">' + escapeHtml(cat) + '</div>';
            categories[cat].forEach(function(s) {
                const hasOverride = s.has_override;
                const desc = s.description ? escapeHtml(s.description.substring(0, 80)) + (s.description.length > 80 ? '...' : '') : 'No description';
                const modelBadge = s.model ? '<span class="badge badge-info">' + s.model + '</span>' : '';
                const toolsBadge = s.tools && s.tools.length > 0 ? '<span class="badge badge-warning">' + s.tools.length + ' tools</span>' : '';
                const overrideBadge = hasOverride ? '<span class="badge" style="background: #fef3c7; color: #92400e;">OVERRIDDEN</span>' : '';

                html += '<div class="global-skill-row' + (hasOverride ? ' has-override' : '') + '">';
                html += '<div style="flex: 1;">';
                html += '<div><span style="font-weight: 500;">' + escapeHtml(s.name) + '</span> ' + modelBadge + toolsBadge + ' ' + overrideBadge + '</div>';
                html += '<div style="font-size: 12px; color: var(--text-muted);">' + desc + '</div>';
                html += '</div>';
                html += '<div style="display: flex; gap: 4px; align-items: center;">';
                if (hasOverride) {
                    html += '<button class="btn btn-sm" style="background: #fef3c7; color: #92400e; border-color: #f59e0b;" onclick="resetSkillToGlobal(\'' + escapeHtml(s.name) + '\', \'' + escapeHtml(s.file_name) + '\')">Reset to Global</button>';
                } else {
                    html += '<button class="btn btn-sm btn-primary" onclick="forkSkillToContext(\'' + escapeHtml(s.name) + '\')">Fork to Context</button>';
                }
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';
        });
    }

    // --- Divider ---
    html += '<div style="border-top: 2px solid var(--border); margin: 16px 0;"></div>';

    // --- Context Skills (existing behavior) ---
    html += '<div class="card-header"><span class="card-title">Context Skills (' + skillListCache.length + ')</span>';
    html += '<button class="btn btn-sm btn-primary" onclick="showNewSkillModal()">+ New Skill</button>';
    html += '</div>';

    if (skillListCache.length === 0) {
        html += '<div class="empty-state">No custom skills in this context</div>';
    } else {
        html += skillListCache.map(function(s) {
            const sizeKB = (s.size / 1024).toFixed(1);
            const desc = s.description ? escapeHtml(s.description.substring(0, 60)) + (s.description.length > 60 ? '...' : '') : 'No description';
            const modelBadge = s.model ? '<span class="badge badge-info">' + s.model + '</span>' : '';
            const toolsBadge = s.tools ? '<span class="badge badge-warning">' + s.tools.length + ' tools</span>' : '';

            // Check if this context skill overrides a global skill
            const overridesGlobal = globalSkills.some(function(gs) { return gs.name === s.name.replace('.md', '') || gs.file_name === s.name; });
            const overrideBadge = overridesGlobal ? '<span class="badge" style="background: #fef3c7; color: #92400e;">OVERRIDES GLOBAL</span>' : '';

            return '<div class="skill-row" id="skill-row-' + escapeHtml(s.name) + '" onclick="selectSkill(\'' + escapeHtml(s.name) + '\')">' +
                '<div>' +
                '<div><span style="font-weight: 500;">' + escapeHtml(s.name) + '</span>' + modelBadge + toolsBadge + ' ' + overrideBadge + '</div>' +
                '<div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">' + desc + ' (' + sizeKB + ' KB)</div>' +
                '</div>' +
                '<div style="display: flex; gap: 4px; align-items: center;" onclick="event.stopPropagation();">' +
                '<button class="btn btn-sm btn-danger" onclick="deleteSkill(\'' + escapeHtml(s.name) + '\')">Delete</button>' +
                '</div>' +
                '</div>';
        }).join('');
    }

    html += '<div id="skillEditorContainer"></div>';
    card.innerHTML = html;

    if (currentSkill) {
        selectSkill(currentSkill);
    }
}

async function selectSkill(fileName) {
    currentSkill = fileName;

    document.querySelectorAll('.skill-row').forEach(function(row) {
        row.classList.remove('active');
    });
    const rowElement = document.getElementById('skill-row-' + fileName);
    if (rowElement) {
        rowElement.classList.add('active');
    }

    const container = document.getElementById('skillEditorContainer');
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/skills/' + encodeURIComponent(fileName));
    if (!res) {
        container.innerHTML = '<div class="empty-state">Failed to load skill</div>';
        return;
    }
    const data = await res.json();

    const fm = data.frontmatter || {};
    const skillName = fm.name || fileName.replace('.md', '');
    const description = fm.description || '';
    const model = fm.model || 'agentchat';
    const maxTurns = fm.max_turns || 10;
    const tools = fm.tools || [];

    let html = '<div class="skill-editor">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
    html += '<h4 style="margin: 0;">Editing: ' + escapeHtml(fileName) + '</h4>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<button class="btn btn-sm" onclick="closeSkillEditor()">Close</button>';
    html += '<button class="btn btn-sm btn-primary" onclick="saveSkill()">Save</button>';
    html += '</div></div>';

    html += '<div class="frontmatter-section">';
    html += '<h4>Skill Metadata</h4>';
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">';
    html += '<div class="form-group" style="margin: 0;"><label>Skill Name</label><input type="text" id="skillEditName" value="' + escapeHtml(skillName) + '" pattern="[a-z0-9_]+"></div>';
    html += '<div class="form-group" style="margin: 0;"><label>Model</label><select id="skillEditModel">';
    html += '<option value="agentchat"' + (model === 'agentchat' ? ' selected' : '') + '>agentchat</option>';
    html += '<option value="skillsrunner"' + (model === 'skillsrunner' ? ' selected' : '') + '>skillsrunner</option>';
    html += '<option value="skillsrunner_deep"' + (model === 'skillsrunner_deep' ? ' selected' : '') + '>skillsrunner_deep</option>';
    html += '</select></div>';
    html += '</div>';
    html += '<div class="form-group" style="margin: 0 0 12px 0;"><label>Description</label><input type="text" id="skillEditDescription" value="' + escapeHtml(description) + '"></div>';
    html += '<div class="form-group" style="margin: 0 0 12px 0;"><label>Max Turns</label><input type="number" id="skillEditMaxTurns" value="' + maxTurns + '" min="1" max="30"></div>';
    html += '<div class="form-group" style="margin: 0;"><label>Tools</label>';
    html += '<div class="tools-checkboxes">';
    AVAILABLE_TOOLS.forEach(function(tool) {
        const checked = tools.includes(tool) ? ' checked' : '';
        html += '<label><input type="checkbox" name="skillEditTools" value="' + tool + '"' + checked + '>' + tool + '</label>';
    });
    html += '</div></div>';
    html += '</div>';

    html += '<div class="form-group">';
    html += '<label>Skill Instructions (Markdown Body)</label>';

    let bodyContent = data.content || '';
    if (bodyContent.startsWith('---')) {
        const parts = bodyContent.split('---', 3);
        if (parts.length >= 3) {
            bodyContent = parts[2].trim();
        }
    }

    html += '<textarea id="skillEditBody">' + escapeHtml(bodyContent) + '</textarea>';
    html += '</div>';
    html += '</div>';

    container.innerHTML = html;
}

function closeSkillEditor() {
    currentSkill = null;
    document.getElementById('skillEditorContainer').innerHTML = '';
    document.querySelectorAll('.skill-row').forEach(function(row) {
        row.classList.remove('active');
    });
}

async function saveSkill() {
    if (!currentSkill) return;

    const name = document.getElementById('skillEditName').value;
    const description = document.getElementById('skillEditDescription').value;
    const model = document.getElementById('skillEditModel').value;
    const maxTurns = parseInt(document.getElementById('skillEditMaxTurns').value);
    const body = document.getElementById('skillEditBody').value;

    const toolCheckboxes = document.querySelectorAll('input[name="skillEditTools"]:checked');
    const tools = Array.from(toolCheckboxes).map(cb => cb.value);

    let content = '---\n';
    content += 'name: "' + name + '"\n';
    content += 'description: "' + description.replace(/"/g, '\\"') + '"\n';
    content += 'tools: [' + tools.map(t => '"' + t + '"').join(', ') + ']\n';
    content += 'model: ' + model + '\n';
    content += 'max_turns: ' + maxTurns + '\n';
    content += '---\n\n';
    content += body;

    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/skills/' + encodeURIComponent(currentSkill), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
    });
    if (res) {
        showToast('Skill saved', 'success');
        loadedTabs['skills'] = false;
        loadSkills();
    }
}

async function deleteSkill(fileName) {
    if (!confirm('Delete skill "' + fileName + '"? This cannot be undone.')) return;
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/skills/' + encodeURIComponent(fileName), { method: 'DELETE' });
    if (res) {
        showToast('Skill deleted', 'success');
        if (currentSkill === fileName) {
            currentSkill = null;
        }
        loadedTabs['skills'] = false;
        loadSkills();
    }
}

function showNewSkillModal() {
    const grid = document.getElementById('newSkillToolsGrid');
    grid.innerHTML = AVAILABLE_TOOLS.map(function(tool) {
        return '<label><input type="checkbox" name="newSkillTools" value="' + tool + '">' + tool + '</label>';
    }).join('');

    document.getElementById('newSkillModal').style.display = 'flex';
}

function hideNewSkillModal() {
    document.getElementById('newSkillModal').style.display = 'none';
    document.getElementById('newSkillForm').reset();
}

async function submitNewSkill(e) {
    e.preventDefault();

    const name = document.getElementById('newSkillName').value;
    const description = document.getElementById('newSkillDescription').value;
    const model = document.getElementById('newSkillModel').value;
    const maxTurns = parseInt(document.getElementById('newSkillMaxTurns').value);

    const toolCheckboxes = document.querySelectorAll('input[name="newSkillTools"]:checked');
    const tools = Array.from(toolCheckboxes).map(cb => cb.value);

    let content = '---\n';
    content += 'name: "' + name + '"\n';
    content += 'description: "' + description.replace(/"/g, '\\"') + '"\n';
    content += 'tools: [' + tools.map(t => '"' + t + '"').join(', ') + ']\n';
    content += 'model: ' + model + '\n';
    content += 'max_turns: ' + maxTurns + '\n';
    content += '---\n\n';
    content += '# ' + name + '\n\n';
    content += 'Add skill instructions here.\n';

    const fileName = name + '.md';

    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/skills/' + encodeURIComponent(fileName), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
    });
    if (res) {
        showToast('Skill created', 'success');
        hideNewSkillModal();
        loadedTabs['skills'] = false;
        await loadSkills();
        selectSkill(fileName);
    }
}

async function forkSkillToContext(skillName) {
    if (!confirm('Fork global skill "' + skillName + '" to this context for customization?')) return;
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/global-skills/' + encodeURIComponent(skillName) + '/fork', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });
    if (res) {
        const data = await res.json();
        showToast('Skill forked: ' + (data.file_name || skillName), 'success');
        loadedTabs['skills'] = false;
        loadSkills();
    }
}

async function resetSkillToGlobal(skillName, fileName) {
    if (!confirm('Reset "' + skillName + '" to the global version? This will DELETE the context override file "' + fileName + '". The global skill will take effect again.')) return;
    const res = await fetchWithErrorHandling('/platformadmin/contexts/' + CONTEXT_ID + '/api/skills/' + encodeURIComponent(fileName), { method: 'DELETE' });
    if (res) {
        showToast('Reset to global: ' + skillName, 'success');
        if (currentSkill === fileName) {
            currentSkill = null;
        }
        loadedTabs['skills'] = false;
        loadSkills();
    }
}

// Initialize: read hash from URL on page load
const initialTab = window.location.hash.replace('#', '') || 'overview';
switchTab(initialTab);
