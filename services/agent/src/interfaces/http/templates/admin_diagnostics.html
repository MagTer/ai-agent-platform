<!-- CONTENT_SECTION -->
        <!-- Toolbar with tabs and actions -->
        <div class="diag-toolbar">
            <div class="diag-tab-nav">
                <div id="tab-traces" class="diag-nav-item active" onclick="switchTab('traces')">Trace Waterfall</div>
                <div id="tab-metrics" class="diag-nav-item" onclick="switchTab('metrics')">Metrics &amp; Insights</div>
                <div id="tab-health" class="diag-nav-item" onclick="switchTab('health')">System Health</div>
                <div id="tab-logs" class="diag-nav-item" onclick="switchTab('logs')">Logs &amp; Events</div>
            </div>
            <div class="diag-toolbar-actions">
                <button onclick="viewCrashLog()" class="btn">View Crash Log</button>
                <button onclick="refreshCurrent()" class="btn">Refresh</button>
            </div>
        </div>

        <!-- Trace Screen -->
        <div class="diag-screen" id="view-traces" style="display:flex">
            <div class="diag-sidebar">
                <div class="diag-sidebar-header">
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
                        <span>RECENT REQUESTS</span>
                        <span id="trace-count">0</span>
                    </div>
                    <input type="text" id="traceSearch" placeholder="Search by Trace ID..."
                           oninput="onTraceSearchInput()"
                           class="diag-search-input">
                    <label class="diag-checkbox-label">
                        <input type="checkbox" id="showAllTraces" onchange="loadTraces()">
                        Show diagnostic/health traces
                    </label>
                </div>
                <div class="diag-request-list" id="reqList"></div>
            </div>

            <div class="diag-main">
                <div id="emptyState" class="diag-empty-state">
                    <div style="font-size:40px; margin-bottom:10px">Select a request</div>
                    <div>Select a request to view details</div>
                </div>

                <div id="detailView" class="diag-trace-detail diag-hidden">
                    <div class="diag-detail-header">
                        <div class="diag-dh-title" id="dTitle">Query...</div>
                        <div class="diag-dh-meta">
                            <span id="dId">ID</span>
                            <span id="dTime">Time</span>
                            <span id="dDur">Duration</span>
                        </div>
                    </div>

                    <div class="diag-waterfall-scroll">
                        <div class="diag-waterfall-canvas" id="waterfall"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Screen -->
        <div class="diag-screen diag-health-screen" id="view-health">
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px">
                    <div>
                        <h2 class="diag-section-title" style="margin:0">Component Health Status</h2>
                        <div style="color:var(--text-muted); font-size:13px; margin-top:4px">Real-time integration tests</div>
                    </div>
                    <button onclick="runHealthChecks()" class="btn btn-primary">Run Integration Tests</button>
                </div>

                <div class="diag-health-grid" id="healthGrid">
                    <div style="grid-column: 1/-1; padding:40px; text-align:center; color:var(--text-muted); border: 2px dashed var(--border); border-radius:8px;">
                        Click "Run Integration Tests" to start probing.
                    </div>
                </div>

                <h2 class="diag-section-title" style="margin-top:40px; margin-bottom:16px">MCP Server Status</h2>
                <div id="mcpStatusContainer">
                    <div style="padding:40px; text-align:center; color:var(--text-muted); border: 2px dashed var(--border); border-radius:8px; background:white;">
                        Loading MCP server status...
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Screen -->
        <div class="diag-screen diag-health-screen" id="view-metrics">
            <div style="max-width: 1000px; margin: 0 auto;">
                <h2 class="diag-section-title">Live Platform Metrics (OTel)</h2>
                <div class="diag-metric-cards" id="otelMetricCards">
                    <div class="diag-m-card">
                        <div class="diag-m-title">Total Requests</div>
                        <div class="diag-m-value" id="otelReqTotal">-</div>
                    </div>
                    <div class="diag-m-card">
                        <div class="diag-m-title">Error Rate</div>
                        <div class="diag-m-value" id="otelErrorRate">-</div>
                    </div>
                    <div class="diag-m-card">
                        <div class="diag-m-title">Avg Latency</div>
                        <div class="diag-m-value" id="otelAvgLatency">-</div>
                    </div>
                    <div class="diag-m-card">
                        <div class="diag-m-title">LLM Tokens</div>
                        <div class="diag-m-value" id="otelLlmTokens">-</div>
                    </div>
                    <div class="diag-m-card">
                        <div class="diag-m-title">Tool Errors</div>
                        <div class="diag-m-value" id="otelToolErrors">-</div>
                    </div>
                    <div class="diag-m-card">
                        <div class="diag-m-title">Active Requests</div>
                        <div class="diag-m-value" id="otelActiveReqs">-</div>
                    </div>
                </div>

                <h2 class="diag-section-title" style="margin-top:32px">Recent Errors</h2>
                <table id="recentErrorsTable" class="diag-table">
                    <thead>
                        <tr>
                            <th style="width:120px">Time</th>
                            <th style="width:150px">Trace</th>
                            <th>Error</th>
                            <th style="width:150px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recentErrorsBody">
                        <tr><td colspan="4" style="text-align:center; color:#999">Loading...</td></tr>
                    </tbody>
                </table>

                <h2 class="diag-section-title" style="margin-top:32px">System Metrics (Last 60 Traces)</h2>
                <div class="diag-metric-cards">
                    <div class="diag-m-card">
                        <div class="diag-m-title">Total Requests</div>
                        <div class="diag-m-value" id="mTotal">-</div>
                    </div>
                    <div class="diag-m-card">
                        <div class="diag-m-title">Error Rate</div>
                        <div class="diag-m-value" id="mRate">-</div>
                    </div>
                    <div class="diag-m-card">
                        <div class="diag-m-title">Failed Requests</div>
                        <div class="diag-m-value" id="mCount">-</div>
                    </div>
                </div>

                <h2 class="diag-section-title">Insights: Failing Components</h2>
                <table class="diag-table" id="hotspotsTable">
                    <thead>
                        <tr>
                            <th style="width:200px">Component / Tool</th>
                            <th style="width:100px">Failures</th>
                            <th>Top Error Reasons</th>
                        </tr>
                    </thead>
                    <tbody id="hotspotsBody">
                        <tr><td colspan="3" style="text-align:center; color:#999">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Logs & Events Screen -->
        <div class="diag-screen diag-health-screen" id="view-logs">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h2 class="diag-section-title">Debug Logs</h2>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
                    <div style="display:flex; gap:16px; align-items:center">
                        <div class="debug-toggle-container">
                            <label class="debug-toggle">
                                <input type="checkbox" id="debugToggle" onchange="toggleDebugLogging(this.checked)">
                                <span class="debug-toggle-slider"></span>
                            </label>
                            <span id="debugToggleLabel" style="font-weight:600; font-size:13px">Loading...</span>
                        </div>
                        <span style="font-size:13px; color:var(--text-muted)">Total: <strong id="debugLogCount">-</strong> logs</span>
                    </div>
                    <button class="btn" onclick="loadDebugLogs()">Refresh</button>
                </div>

                <div id="debugTraceFilter" style="display:none; margin-bottom:12px; background:#fef3c7; border-left:4px solid #f59e0b; padding:12px 16px; border-radius:0 8px 8px 0">
                    <strong>Filtered by trace:</strong> <code id="debugTraceFilterId"></code>
                    <a href="#" onclick="clearDebugTraceFilter(); return false" style="margin-left:12px; color:#0369a1; text-decoration:none; font-weight:600">Show all</a>
                </div>

                <div style="overflow-x:auto; margin-bottom:24px">
                    <table class="diag-table" id="debugLogsTable">
                        <thead>
                            <tr>
                                <th style="width:120px">Trace ID</th>
                                <th style="width:100px">Event</th>
                                <th style="width:120px">Conversation</th>
                                <th>Data Preview</th>
                                <th style="width:80px">Time</th>
                                <th style="width:60px">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="debugLogsBody">
                            <tr><td colspan="6" style="text-align:center; color:#999">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="background:#dbeafe; border-left:4px solid var(--primary); padding:16px; margin-bottom:32px; border-radius:0 8px 8px 0; font-size:13px">
                    <strong>Debug Logging captures:</strong>
                    <ul style="margin:10px 0 0; padding-left:20px">
                        <li><strong>request</strong> - Incoming prompt, messages, metadata</li>
                        <li><strong>history</strong> - Message history source and contents</li>
                        <li><strong>plan</strong> - Generated execution plan</li>
                        <li><strong>tool_call</strong> - Tool executions with args and results</li>
                        <li><strong>supervisor</strong> - Supervisor decisions (SUCCESS/RETRY/REPLAN/ABORT)</li>
                        <li><strong>completion_prompt</strong> - Full prompt sent to completion LLM</li>
                        <li><strong>completion_response</strong> - LLM response</li>
                    </ul>
                    <p style="margin-top:10px; margin-bottom:0">
                        Debug events are stored as OTel span events in <code>data/spans.jsonl</code>.
                    </p>
                </div>

                <!-- Debug Log Detail Modal -->
                <div class="diag-modal" id="debugLogModal" onclick="if(event.target===this) closeDebugLogModal()">
                    <div class="diag-modal-content">
                        <div class="diag-modal-header">
                            <h3 style="margin:0; font-size:16px; font-weight:600">Debug Log Details</h3>
                            <div class="diag-close-drawer" onclick="closeDebugLogModal()">&times;</div>
                        </div>
                        <div class="diag-modal-body">
                            <pre class="diag-modal-pre" id="debugLogDetailContent"></pre>
                        </div>
                    </div>
                </div>

                <h2 class="diag-section-title">Application Logs</h2>
                <div style="margin-bottom:16px; display:flex; gap:12px; align-items:center">
                    <select id="logLevelFilter" onchange="loadLogs()" class="diag-select">
                        <option value="">All Levels</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                        <option value="CRITICAL">CRITICAL</option>
                    </select>
                    <input type="text" id="logSearchBox" placeholder="Search logs..." oninput="loadLogs()" class="diag-search-input" style="flex:1; max-width:400px">
                </div>
                <div style="overflow-x:auto; margin-bottom:40px">
                    <table class="diag-table" id="logsTable">
                        <thead>
                            <tr>
                                <th style="width:150px">Timestamp</th>
                                <th style="width:80px">Level</th>
                                <th style="width:200px">Logger</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="logsBody">
                            <tr><td colspan="4" style="text-align:center; color:#999">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <h2 class="diag-section-title">System Events</h2>
                <div style="margin-bottom:16px; display:flex; gap:12px; align-items:center">
                    <select id="eventTypeFilter" onchange="loadEvents()" class="diag-select">
                        <option value="">All Event Types</option>
                    </select>
                    <select id="eventSeverityFilter" onchange="loadEvents()" class="diag-select">
                        <option value="">All Severities</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                        <option value="CRITICAL">CRITICAL</option>
                    </select>
                </div>
                <div style="overflow-x:auto">
                    <table class="diag-table" id="eventsTable">
                        <thead>
                            <tr>
                                <th style="width:150px">Timestamp</th>
                                <th style="width:150px">Event Type</th>
                                <th style="width:100px">Severity</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="eventsBody">
                            <tr><td colspan="4" style="text-align:center; color:#999">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Drawer -->
        <div class="diag-drawer" id="attrDrawer">
            <div class="diag-drawer-header">
                <h3 style="margin:0; font-size:14px;">Span Details</h3>
                <div class="diag-close-drawer" onclick="closeDrawer()">&times;</div>
            </div>
            <div class="diag-drawer-content" id="drawerContent"></div>
        </div>

        <!-- Crash Log Modal -->
        <div class="diag-modal" id="crashLogModal" onclick="if(event.target===this) closeCrashLogModal()">
            <div class="diag-modal-content">
                <div class="diag-modal-header">
                    <h3 style="margin:0; font-size:16px; font-weight:600">Crash Log</h3>
                    <div class="diag-close-drawer" onclick="closeCrashLogModal()">&times;</div>
                </div>
                <div class="diag-modal-body">
                    <div id="crashLogContent">Loading...</div>
                </div>
            </div>
        </div>
<!-- CSS_SECTION -->
        /* Override admin-content padding for full-height layout */
        .admin-content {
            padding: 0;
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--header-height));
            overflow: hidden;
        }

        /* Toolbar */
        .diag-toolbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .diag-tab-nav {
            display: flex;
            gap: 24px;
            font-size: 13px;
            font-weight: 500;
            height: 100%;
        }

        .diag-nav-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            transition: all 0.2s;
            padding: 0 4px;
        }

        .diag-nav-item:hover { color: var(--primary); }
        .diag-nav-item.active { border-bottom-color: var(--primary); color: var(--primary); }

        .diag-toolbar-actions { display: flex; gap: 10px; }

        /* Screens */
        .diag-screen { display: none; flex: 1; overflow: hidden; }
        .diag-health-screen { padding: 40px; background: #fafafa; overflow-y: auto; }
        #view-traces { flex-direction: row; }

        /* Sidebar */
        .diag-sidebar {
            width: 350px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .diag-sidebar-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            background: #f9fafb;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .diag-search-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .diag-checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: normal;
        }

        .diag-select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
        }

        .diag-request-list { flex: 1; overflow-y: auto; }

        .diag-req-card {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.1s;
            border-left: 3px solid transparent;
        }

        .diag-req-card:hover { background: #f9fafb; }
        .diag-req-card.active { background: #eff6ff; border-left-color: var(--primary); }
        .diag-req-card.error { border-left-color: var(--error); background: #fef2f2; }

        .diag-req-top { display: flex; justify-content: space-between; margin-bottom: 6px; }

        .diag-req-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            display: inline-block;
        }

        .diag-req-status.ok { background: var(--success); }
        .diag-req-status.err { background: var(--error); }

        .diag-req-time { font-size: 11px; color: var(--text-muted); font-weight: 500; }

        .diag-req-query {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .diag-req-meta { display: flex; gap: 12px; font-size: 11px; color: var(--text-muted); }
        .diag-badge { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-weight: 500; }

        /* Main view */
        .diag-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            overflow: hidden;
            position: relative;
        }

        .diag-empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            flex-direction: column;
        }

        .diag-hidden { display: none !important; }

        .diag-trace-detail { display: flex; flex-direction: column; height: 100%; }

        .diag-detail-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .diag-dh-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .diag-dh-meta { display: flex; gap: 20px; font-size: 12px; color: var(--text-muted); font-family: monospace; }

        .diag-waterfall-scroll { flex: 1; overflow-y: auto; padding: 20px; position: relative; background: #fafafa; }
        .diag-waterfall-canvas { position: relative; min-height: 200px; }

        .diag-span-row { position: relative; height: 32px; margin-bottom: 4px; }

        .diag-span-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            font-size: 11px;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 8px;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: opacity 0.2s;
        }

        .diag-span-bar:hover { opacity: 0.9; z-index: 10; }

        .diag-bg-ai { background: #3b82f6; }
        .diag-bg-tool { background: #14b8a6; }
        .diag-bg-db { background: #f59e0b; }
        .diag-bg-err { background: #ef4444; }
        .diag-bg-def { background: #9ca3af; }

        /* Tables */
        .diag-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            font-size: 13px;
        }

        .diag-table th {
            text-align: left;
            padding: 12px 16px;
            background: #f9fafb;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        .diag-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .diag-table tr:last-child td { border-bottom: none; }

        .diag-reason-tag {
            display: inline-block;
            background: #fef2f2;
            color: #b91c1c;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-right: 4px;
            border: 1px solid #fecaca;
            margin-bottom: 4px;
        }

        /* Health & Metrics */
        .diag-section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text); }

        .diag-metric-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .diag-m-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .diag-m-title { color: var(--text-muted); font-size: 13px; font-weight: 500; margin-bottom: 8px; text-transform: uppercase; }
        .diag-m-value { font-size: 28px; font-weight: 700; color: var(--text); }
        .diag-m-card.bad .diag-m-value { color: var(--error); }

        .diag-health-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }

        .diag-health-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            border-top-width: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .diag-health-card.ok { border-top-color: var(--success); }
        .diag-health-card.fail { border-top-color: var(--error); }

        /* Drawer */
        .diag-drawer {
            position: fixed;
            bottom: -350px;
            left: 220px;
            right: 0;
            height: 350px;
            background: white;
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            transition: bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .diag-drawer.open { bottom: 0; }

        .diag-drawer-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
        }

        .diag-drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
            display: flex;
            gap: 24px;
        }

        .diag-drawer-attrs { flex: 1; min-width: 300px; }
        .diag-drawer-json { flex: 1; min-width: 300px; }

        .diag-attr-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .diag-attr-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .diag-attr-value { font-size: 13px; font-weight: 500; word-break: break-all; }

        #drawerPre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            overflow-x: auto;
            font-family: 'Menlo', monospace;
            max-height: 250px;
        }

        .diag-close-drawer {
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .diag-close-drawer:hover { background: var(--bg); }

        /* Modal */
        .diag-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .diag-modal.open { display: flex; }

        .diag-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .diag-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diag-modal-body { padding: 20px; overflow-y: auto; flex: 1; }

        .diag-modal-pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 6px;
            font-size: 12px;
            overflow-x: auto;
            font-family: 'Menlo', monospace;
            white-space: pre-wrap;
        }

        /* Debug toggle */
        .debug-toggle-container { display: flex; align-items: center; gap: 10px; }
        .debug-toggle { position: relative; display: inline-block; width: 48px; height: 26px; }
        .debug-toggle input { opacity: 0; width: 0; height: 0; }
        .debug-toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .3s; border-radius: 26px;
        }
        .debug-toggle-slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
            background-color: white; transition: .3s; border-radius: 50%;
        }
        .debug-toggle input:checked + .debug-toggle-slider { background-color: var(--success); }
        .debug-toggle input:checked + .debug-toggle-slider:before { transform: translateX(22px); }

        /* Debug log badges */
        .dbg-badge-blue { background: #dbeafe; color: #1e40af; }
        .dbg-badge-green { background: #d1fae5; color: #065f46; }
        .dbg-badge-orange { background: #ffedd5; color: #9a3412; }
        .dbg-badge-purple { background: #f3e8ff; color: #6b21a8; }
        .dbg-badge-gray { background: #f3f4f6; color: #374151; }
<!-- JS_SECTION -->
        const API_BASE = '/platformadmin/diagnostics';

        let currentTab = 'traces';
        let traceGroups = [];
        let selectedTraceId = null;

        window.switchTab = switchTab;
        window.refreshCurrent = refreshCurrent;
        window.runHealthChecks = runHealthChecks;
        window.closeDrawer = closeDrawer;
        window.viewCrashLog = viewCrashLog;
        window.closeCrashLogModal = closeCrashLogModal;
        window.loadLogs = loadLogs;
        window.loadEvents = loadEvents;
        window.loadTraces = loadTraces;
        window.onTraceSearchInput = onTraceSearchInput;
        window.loadDebugLogs = loadDebugLogs;
        window.toggleDebugLogging = toggleDebugLogging;
        window.showDebugLogDetail = showDebugLogDetail;
        window.closeDebugLogModal = closeDebugLogModal;
        window.clearDebugTraceFilter = clearDebugTraceFilter;

        // Check URL for trace parameter and load accordingly
        const urlParams = new URLSearchParams(window.location.search);
        const traceParam = urlParams.get('trace');
        if (traceParam) {
            loadTraces(traceParam);
        } else {
            loadTraces();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.diag-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.querySelectorAll('.diag-screen').forEach(el => el.style.display = 'none');
            const view = document.getElementById(`view-${tab}`);

            if (tab === 'traces') {
                view.style.display = 'flex';
                loadTraces();
            } else {
                view.style.display = 'block';
                if (tab === 'metrics') loadMetrics();
                else if (tab === 'health') loadMcpStatus();
                else if (tab === 'logs') {
                    loadDebugLogs();
                    loadLogs();
                    loadEvents();
                }
            }
        }

        async function refreshCurrent() {
            const btn = event?.target;
            if (btn) { btn.disabled = true; btn.innerText = 'Loading...'; }
            try {
                if (currentTab === 'traces') await loadTraces();
                else if (currentTab === 'metrics') await loadMetrics();
                else if (currentTab === 'health') await loadMcpStatus();
                else if (currentTab === 'logs') { await loadDebugLogs(); await loadLogs(); await loadEvents(); }
            } finally {
                if (btn) { btn.disabled = false; btn.innerText = 'Refresh'; }
            }
        }

        async function loadMetrics() {
            // Load OTel metrics
            await loadOtelMetrics();

            // Load recent errors
            await loadRecentErrors();

            // Load trace-based metrics
            const res = await fetchWithErrorHandling(`${API_BASE}/metrics?window=60`);
            if (!res) return;

            const data = await res.json();

            document.getElementById('mTotal').innerText = data.metrics?.total_requests || 0;
            document.getElementById('mCount').innerText = data.metrics?.error_count || 0;

            const rateEl = document.getElementById('mRate');
            const rate = ((data.metrics?.error_rate || 0) * 100).toFixed(1) + '%';
            rateEl.innerText = rate;
            if ((data.metrics?.error_rate || 0) > 0.1) rateEl.parentElement.classList.add('bad');
            else rateEl.parentElement.classList.remove('bad');

            const tbody = document.getElementById('hotspotsBody');
            tbody.innerHTML = '';

            if ((data.metrics?.error_count || 0) === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:#999">No errors detected.</td></tr>';
                return;
            }

            if (data.insights && data.insights.hotspots) {
                data.insights.hotspots.forEach(h => {
                    const tr = document.createElement('tr');
                    let reasonsHtml = h.top_reasons.map(r => `<span class="diag-reason-tag">${escapeHtml(r)}</span>`).join('');
                    tr.innerHTML = `<td style="font-weight:600">${escapeHtml(h.name)}</td><td>${h.count}</td><td>${reasonsHtml}</td>`;
                    tbody.appendChild(tr);
                });
            }
        }

        async function loadOtelMetrics() {
            const res = await fetchWithErrorHandling(`${API_BASE}/otel-metrics`);
            if (!res) return;
            const data = await res.json();

            // Computed fields
            const total = data['requests.total'] || 0;
            const errors = data['requests.errors'] || 0;
            const durationSum = data['requests.duration_ms_sum'] || 0;
            const errorRate = total > 0 ? ((errors / total) * 100).toFixed(1) + '%' : '0%';
            const avgLatency = total > 0 ? Math.round(durationSum / total) + 'ms' : '-';
            const tokens = data['llm.tokens.total'] || 0;

            document.getElementById('otelReqTotal').innerText = Math.round(total);
            document.getElementById('otelErrorRate').innerText = errorRate;
            document.getElementById('otelAvgLatency').innerText = avgLatency;
            document.getElementById('otelLlmTokens').innerText = tokens > 1000 ? (tokens/1000).toFixed(1) + 'k' : Math.round(tokens);
            document.getElementById('otelToolErrors').innerText = Math.round(data['tools.errors'] || 0);
            document.getElementById('otelActiveReqs').innerText = Math.round(data['requests.active'] || 0);
        }

        async function loadRecentErrors() {
            // Fetch error traces from traces endpoint with status filter
            const res = await fetchWithErrorHandling(`${API_BASE}/traces?limit=100&show_all=false`);
            if (!res) return;
            const traces = await res.json();

            // Filter for error traces
            const errors = traces.filter(t => {
                return t.spans.some(s => s.status === 'ERROR');
            }).slice(0, 10);

            const tbody = document.getElementById('recentErrorsBody');
            if (!errors.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No recent errors</td></tr>';
                return;
            }

            tbody.innerHTML = errors.map(t => {
                const timestamp = new Date(t.start_time).toLocaleTimeString();
                const traceIdShort = t.trace_id.slice(0, 12) + '...';
                const errorSpan = t.spans.find(s => s.status === 'ERROR');
                const errorMsg = errorSpan ? errorSpan.name : 'Unknown error';

                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td><code><a href="#" onclick="loadTraceDetail('${t.trace_id}'); switchTab('traces'); return false;">${traceIdShort}</a></code></td>
                        <td>${escapeHtml(errorMsg)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="debugTraceFilter='${t.trace_id}'; switchTab('logs'); return false;">Debug Logs</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function runHealthChecks() {
            const grid = document.getElementById('healthGrid');
            grid.innerHTML = '<div style="padding:20px; text-align:center">Running integration tests...</div>';

            const res = await fetchWithErrorHandling(`${API_BASE}/run`, {method: 'POST'});
            if (!res) {
                grid.innerHTML = '<div style="color:red">Failed to run health checks</div>';
                return;
            }

            const results = await res.json();
            grid.innerHTML = '';

            results.forEach(r => {
                const isOk = r.status === 'ok';
                const el = document.createElement('div');
                el.className = `diag-health-card ${isOk ? 'ok' : 'fail'}`;
                el.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                        <span style="font-weight:600; font-size:14px">${escapeHtml(r.component)}</span>
                        <span style="font-size:10px; font-weight:bold; padding:2px 6px; border-radius:4px; color:white"
                              class="${isOk ? 'diag-bg-tool' : 'diag-bg-err'}">${isOk ? 'Active' : 'Failed'}</span>
                    </div>
                    <div style="font-size:24px; font-weight:700; margin-bottom:4px">${r.latency_ms.toFixed(0)}<span style="font-size:12px; font-weight:400; color:#999; margin-left:4px">ms</span></div>
                    ${!isOk && r.message ? `<div style="font-size:12px; color:var(--error); margin-top:8px">${escapeHtml(r.message)}</div>` : ''}
                `;
                grid.appendChild(el);
            });
        }

        async function loadMcpStatus() {
            const container = document.getElementById('mcpStatusContainer');
            const res = await fetchWithErrorHandling(`${API_BASE}/mcp`);
            if (!res) {
                container.innerHTML = '<div style="color:red; padding:20px">Failed to load MCP status</div>';
                return;
            }

            const data = await res.json();
            container.innerHTML = '';

            if (!data.servers || Object.keys(data.servers).length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-muted); border: 2px dashed var(--border); border-radius:8px; background:white;">No MCP servers configured</div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'diag-health-grid';

            Object.entries(data.servers).forEach(([name, info]) => {
                const isConnected = info.connected;
                const card = document.createElement('div');
                card.className = `diag-health-card ${isConnected ? 'ok' : 'fail'}`;
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                        <span style="font-weight:600; font-size:14px">${escapeHtml(name)}</span>
                        <span style="font-size:10px; font-weight:bold; padding:2px 6px; border-radius:4px; color:white"
                              class="${isConnected ? 'diag-bg-tool' : 'diag-bg-err'}">${isConnected ? 'Connected' : 'Disconnected'}</span>
                    </div>
                    <div style="font-size:24px; font-weight:700; margin-bottom:4px">${info.tools_count || 0}<span style="font-size:12px; font-weight:400; color:#999; margin-left:4px">tools</span></div>
                    ${info.error ? `<div style="font-size:12px; color:var(--error); margin-top:8px">${escapeHtml(info.error)}</div>` : ''}
                `;
                grid.appendChild(card);
            });
            container.appendChild(grid);
        }

        async function loadLogs() {
            const tbody = document.getElementById('logsBody');
            const level = document.getElementById('logLevelFilter')?.value || '';
            const search = document.getElementById('logSearchBox')?.value || '';

            let url = `${API_BASE}/logs?limit=100`;
            if (level) url += `&level=${encodeURIComponent(level)}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            const res = await fetchWithErrorHandling(url);
            if (!res) {
                tbody.innerHTML = '<tr><td colspan="4" style="color:red; padding:20px">Failed to load logs</td></tr>';
                return;
            }

            const data = await res.json();
            tbody.innerHTML = '';

            if (!data.logs || data.logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999">No logs found</td></tr>';
                return;
            }

            data.logs.forEach(log => {
                const tr = document.createElement('tr');
                const levelColor = log.level === 'CRITICAL' ? 'var(--error)' : log.level === 'ERROR' ? '#f59e0b' : 'var(--text-muted)';
                tr.innerHTML = `
                    <td style="font-family:monospace; font-size:11px">${escapeHtml(log.timestamp || '')}</td>
                    <td><span style="color:${levelColor}; font-weight:600; font-size:11px">${escapeHtml(log.level || '')}</span></td>
                    <td style="font-family:monospace; font-size:11px">${escapeHtml(log.name || '')}</td>
                    <td style="font-size:12px">${escapeHtml(log.message || '')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadEvents() {
            const tbody = document.getElementById('eventsBody');
            const eventType = document.getElementById('eventTypeFilter')?.value || '';
            const severity = document.getElementById('eventSeverityFilter')?.value || '';

            let url = `${API_BASE}/events?limit=100`;
            if (eventType) url += `&event_type=${encodeURIComponent(eventType)}`;
            if (severity) url += `&severity=${encodeURIComponent(severity)}`;

            const res = await fetchWithErrorHandling(url);
            if (!res) {
                tbody.innerHTML = '<tr><td colspan="4" style="color:red; padding:20px">Failed to load events</td></tr>';
                return;
            }

            const data = await res.json();
            tbody.innerHTML = '';

            if (!data.events || data.events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999">No events found</td></tr>';
                return;
            }

            const eventTypeFilter = document.getElementById('eventTypeFilter');
            if (eventTypeFilter.options.length === 1) {
                const eventTypes = new Set(data.events.map(e => e.event_type).filter(Boolean));
                eventTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    eventTypeFilter.appendChild(option);
                });
            }

            data.events.forEach(event => {
                const tr = document.createElement('tr');
                const severityColor = event.severity === 'CRITICAL' || event.severity === 'ERROR' ? 'var(--error)' : event.severity === 'WARNING' ? '#f59e0b' : 'var(--text)';
                const details = typeof event.details === 'object' ? JSON.stringify(event.details) : event.details || '';
                tr.innerHTML = `
                    <td style="font-family:monospace; font-size:11px">${escapeHtml(event.timestamp || '')}</td>
                    <td style="font-weight:600; font-size:11px">${escapeHtml(event.event_type || '')}</td>
                    <td><span style="color:${severityColor}; font-weight:600; font-size:11px">${escapeHtml(event.severity || '')}</span></td>
                    <td style="font-size:12px">${escapeHtml(details)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function viewCrashLog() {
            const modal = document.getElementById('crashLogModal');
            const content = document.getElementById('crashLogContent');
            content.innerHTML = 'Loading...';
            modal.classList.add('open');

            const res = await fetchWithErrorHandling(`${API_BASE}/crash-log`);
            if (!res) {
                content.innerHTML = '<div style="color:red; padding:20px">Failed to load crash log</div>';
                return;
            }

            const data = await res.json();

            if (!data.exists) {
                content.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">No crash log found</div>';
                return;
            }

            const pre = document.createElement('pre');
            pre.className = 'diag-modal-pre';
            pre.textContent = data.content;
            content.innerHTML = '';
            content.appendChild(pre);

            if (data.modified) {
                const timestamp = document.createElement('div');
                timestamp.style.cssText = 'font-size:12px; color:var(--text-muted); margin-top:12px';
                timestamp.textContent = `Last modified: ${new Date(data.modified).toLocaleString()}`;
                content.appendChild(timestamp);
            }
        }

        function closeCrashLogModal() { document.getElementById('crashLogModal').classList.remove('open'); }

        // --- Debug Logs ---
        let debugLogs = [];
        let debugTraceFilter = null;

        const DEBUG_EVENT_COLORS = {
            request: 'dbg-badge-blue',
            history: 'dbg-badge-purple',
            plan: 'dbg-badge-green',
            tool_call: 'dbg-badge-orange',
            supervisor: 'dbg-badge-gray',
            completion_prompt: 'dbg-badge-blue',
            completion_response: 'dbg-badge-green',
        };

        async function loadDebugLogs() {
            // Load status first
            const statusRes = await fetchWithErrorHandling(`${API_BASE}/debug-status`);
            if (statusRes) {
                const status = await statusRes.json();
                document.getElementById('debugToggle').checked = status.enabled;
                document.getElementById('debugToggleLabel').textContent = status.enabled ? 'Enabled' : 'Disabled';
                document.getElementById('debugLogCount').textContent = status.log_count;
            }

            // Load logs
            let url = `${API_BASE}/debug-logs?limit=50`;
            if (debugTraceFilter) url = `${API_BASE}/debug-logs?limit=500&trace_id=${encodeURIComponent(debugTraceFilter)}`;

            const res = await fetchWithErrorHandling(url);
            const tbody = document.getElementById('debugLogsBody');
            if (!res) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:red; padding:20px">Failed to load debug logs</td></tr>';
                return;
            }

            debugLogs = await res.json();

            // Show/hide trace filter banner
            const filterEl = document.getElementById('debugTraceFilter');
            if (debugTraceFilter) {
                filterEl.style.display = 'block';
                document.getElementById('debugTraceFilterId').textContent = debugTraceFilter;
            } else {
                filterEl.style.display = 'none';
            }

            tbody.innerHTML = '';
            if (!debugLogs.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999">No debug logs. Enable debug logging and make a request.</td></tr>';
                return;
            }

            debugLogs.forEach((log, idx) => {
                const tr = document.createElement('tr');
                const traceId = log.trace_id || '';
                const traceIdShort = traceId ? traceId.slice(0, 12) + '...' : '-';
                const eventType = log.event_type || '';
                const colorClass = DEBUG_EVENT_COLORS[eventType] || 'dbg-badge-gray';
                const convId = log.conversation_id || '';
                const convIdShort = convId ? convId.slice(0, 12) + '...' : '-';
                const eventData = JSON.stringify(log.event_data || {});
                const preview = eventData.length > 100 ? eventData.slice(0, 100) + '...' : eventData;
                const timestamp = (log.timestamp || '').slice(-15, -7);

                tr.innerHTML = `
                    <td><code><a href="#" onclick="loadTraceDetail('${traceId}'); switchTab('traces'); return false;" title="${escapeHtml(traceId)}">${escapeHtml(traceIdShort)}</a></code></td>
                    <td><span class="badge ${colorClass}">${escapeHtml(eventType)}</span></td>
                    <td style="font-size:11px">${escapeHtml(convIdShort)}</td>
                    <td style="font-size:12px" title="${escapeHtml(eventData)}">${escapeHtml(preview)}</td>
                    <td style="font-family:monospace; font-size:11px">${escapeHtml(timestamp)}</td>
                    <td><button class="btn btn-sm" onclick="showDebugLogDetail(${idx})">View</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleDebugLogging(enabled) {
            const res = await fetchWithErrorHandling(`${API_BASE}/debug-toggle`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled})
            });
            if (res) {
                document.getElementById('debugToggleLabel').textContent = enabled ? 'Enabled' : 'Disabled';
                showToast(enabled ? 'Debug logging enabled' : 'Debug logging disabled', 'success');
            } else {
                document.getElementById('debugToggle').checked = !enabled;
            }
        }

        function showDebugLogDetail(idx) {
            const log = debugLogs[idx];
            if (!log) return;
            document.getElementById('debugLogDetailContent').textContent = JSON.stringify(log, null, 2);
            document.getElementById('debugLogModal').classList.add('open');
        }

        function closeDebugLogModal() {
            document.getElementById('debugLogModal').classList.remove('open');
        }

        function clearDebugTraceFilter() {
            debugTraceFilter = null;
            loadDebugLogs();
        }

        function loadTraceDetail(traceId) {
            // Search for trace and select it
            const idx = traceGroups.findIndex(g => g.trace_id === traceId);
            if (idx >= 0) {
                selectTrace(idx);
            } else {
                // Reload traces with search
                loadTraces(traceId);
            }
        }

        let filteredTraceGroups = [];

        async function loadTraces(searchTraceId = null) {
            const list = document.getElementById('reqList');
            const showAll = document.getElementById('showAllTraces')?.checked || false;

            let url = `${API_BASE}/traces?limit=500&show_all=${showAll}`;
            if (searchTraceId && searchTraceId.length >= 8) url += `&trace_id=${encodeURIComponent(searchTraceId)}`;

            const res = await fetchWithErrorHandling(url);
            if (!res) {
                list.innerHTML = '<div style="padding:20px; color:red">Failed to load traces</div>';
                return;
            }

            traceGroups = await res.json();
            filterTraces();

            // If we searched for a specific trace, auto-select the first result
            if (searchTraceId && traceGroups.length > 0) {
                selectTrace(0);
            } else if (selectedTraceId) {
                const idx = traceGroups.findIndex(g => g.trace_id === selectedTraceId);
                if (idx >= 0) selectTrace(idx);
            }
        }

        function filterTraces() {
            const query = (document.getElementById('traceSearch')?.value || '').toLowerCase();
            filteredTraceGroups = query ? traceGroups.filter(g => g.trace_id.toLowerCase().includes(query)) : traceGroups;
            renderTraceList(document.getElementById('reqList'));
        }

        let searchTimeout = null;
        function onTraceSearchInput() {
            const query = document.getElementById('traceSearch')?.value || '';
            clearTimeout(searchTimeout);
            if (query.length >= 8 && /^[a-f0-9]+$/i.test(query)) {
                searchTimeout = setTimeout(() => loadTraces(query), 300);
            } else {
                filterTraces();
            }
        }

        function renderTraceList(list) {
            list.innerHTML = '';
            document.getElementById('trace-count').innerText = filteredTraceGroups.length;

            filteredTraceGroups.forEach((g, idx) => {
                const el = document.createElement('div');
                el.className = `diag-req-card ${g.status === 'ERR' ? 'error' : ''}`;
                const originalIdx = traceGroups.findIndex(t => t.trace_id === g.trace_id);
                el.onclick = () => selectTrace(originalIdx);

                const time = new Date(g.start_time).toLocaleTimeString();
                const intent = extractUserIntent(g.root);

                el.innerHTML = `
                    <div class="diag-req-top">
                        <span class="diag-req-status ${g.status === 'ERR' ? 'err' : 'ok'}"></span>
                        <span class="diag-req-time">${time}</span>
                    </div>
                    <div class="diag-req-query">${escapeHtml(intent)}</div>
                    <div class="diag-req-meta">
                        <span class="diag-badge" title="${g.trace_id}" style="font-family:monospace; font-size:10px">${g.trace_id.substring(0,8)}</span>
                        <span class="diag-badge">${(g.total_duration_ms/1000).toFixed(1)}s</span>
                        <span class="diag-badge">${g.spans.length} spans</span>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function selectTrace(idx) {
            const g = traceGroups[idx];
            if (!g) return;

            selectedTraceId = g.trace_id;

            document.getElementById('emptyState').classList.add('diag-hidden');
            document.getElementById('detailView').classList.remove('diag-hidden');

            document.getElementById('dTitle').innerText = extractUserIntent(g.root);
            document.getElementById('dId').innerText = g.trace_id;
            document.getElementById('dDur').innerText = `${g.total_duration_ms.toFixed(0)} ms`;
            document.getElementById('dTime').innerText = new Date(g.start_time).toLocaleString();

            renderWaterfall(g);
        }

        function renderWaterfall(g) {
            const container = document.getElementById('waterfall');
            container.innerHTML = '';

            const totalDur = Math.max(g.total_duration_ms, 1);
            const baseTime = new Date(g.start_time).getTime();

            g.spans.forEach(span => {
                const start = new Date(span.start_time).getTime();
                const offset = start - baseTime;

                let bg = 'diag-bg-def';
                const name = (span.name || '').toLowerCase();
                const type = span.attributes?.type;

                if (span.status === 'ERROR' || span.status === 'fail') bg = 'diag-bg-err';
                else if (name.includes('completion') || type === 'ai') bg = 'diag-bg-ai';
                else if (name.includes('tool') || span.attributes?.['tool.name']) bg = 'diag-bg-tool';
                else if (name.includes('postgres') || name.includes('db')) bg = 'diag-bg-db';

                const left = (offset / totalDur) * 100;
                const width = Math.max((span.duration_ms / totalDur) * 100, 0.5);

                const row = document.createElement('div');
                row.className = 'diag-span-row';

                const bar = document.createElement('div');
                bar.className = `diag-span-bar ${bg}`;
                bar.style.left = `${left}%`;
                bar.style.width = `${width}%`;

                let label = span.name;
                const attrs = span.attributes || {};

                if (label.startsWith('executor.step_run')) label = `Step ${attrs.step || '?'}`;
                else if (label.startsWith('skill.tool.') || label.includes('tool.call.')) {
                    const toolName = attrs['tool.name'] || label.split('.').pop();
                    label = `Tool ${toolName}`;
                } else if (label.startsWith('skill.execution.')) {
                    label = `Skill: ${label.replace('skill.execution.', '')}`;
                }

                bar.innerText = label;
                bar.onclick = () => showDetails(span);

                row.appendChild(bar);
                container.appendChild(row);
            });
        }

        function showDetails(span) {
            const drawer = document.getElementById('attrDrawer');
            const content = document.getElementById('drawerContent');
            const attrs = span.attributes || {};

            let attrCards = '';

            if (attrs['error.type'] || attrs['error.message']) {
                attrCards += `
                    <div class="diag-attr-card" style="background:#fef2f2; border-color:#fecaca">
                        <div class="diag-attr-label" style="color:#b91c1c">Exception</div>
                        <div class="diag-attr-value" style="color:#b91c1c; font-weight:600">${escapeHtml(attrs['error.type'] || 'Error')}</div>
                        ${attrs['error.message'] ? `<div class="diag-attr-value" style="margin-top:8px; font-size:12px; color:#991b1b">${escapeHtml(attrs['error.message'])}</div>` : ''}
                    </div>
                `;
            }

            const keyAttrs = [
                { key: 'tool.name', label: 'Tool Name' },
                { key: 'tool.output_preview', label: 'Output Preview' },
                { key: 'tool.status', label: 'Status' },
            ];

            keyAttrs.forEach(({key, label}) => {
                if (attrs[key]) {
                    attrCards += `
                        <div class="diag-attr-card">
                            <div class="diag-attr-label">${label}</div>
                            <div class="diag-attr-value">${escapeHtml(String(attrs[key]))}</div>
                        </div>
                    `;
                }
            });

            content.innerHTML = `
                <div class="diag-drawer-attrs">
                    <div style="font-weight:600; font-size:16px; margin-bottom:12px">${escapeHtml(span.name)}</div>
                    <div style="margin-bottom:16px">
                        <span class="diag-badge ${span.status==='ERROR' ? 'diag-bg-err' : 'diag-bg-ai'}" style="color:white">${span.status}</span>
                        <span class="diag-badge">${span.duration_ms.toFixed(1)} ms</span>
                    </div>
                    ${attrCards || '<div style="color:var(--text-muted)">No key attributes</div>'}
                </div>
                <div class="diag-drawer-json">
                    <div class="diag-attr-label" style="margin-bottom:8px">Raw Span Data</div>
                    <pre id="drawerPre">${JSON.stringify(span, null, 2)}</pre>
                </div>
            `;

            drawer.classList.add('open');
        }

        function closeDrawer() { document.getElementById('attrDrawer').classList.remove('open'); }

        function extractUserIntent(span) {
            if (!span || !span.attributes) return "System Action";
            const body = span.attributes['http.request.body'] || span.attributes['body'];
            if (body) {
                try {
                    const obj = typeof body === 'string' ? JSON.parse(body) : body;
                    if (obj.messages) {
                        const user = obj.messages.find(m => m.role === 'user');
                        if (user) return user.content;
                    }
                    if (obj.prompt) return obj.prompt;
                } catch(e) { if (typeof body === 'string' && body.length > 4) return body; }
            }
            return span.name;
        }
