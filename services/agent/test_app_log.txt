============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.0, pluggy-1.6.0 -- /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/bin/python
cachedir: .pytest_cache
rootdir: /home/magnus/dev/ai-agent-platform/services/agent
configfile: pyproject.toml
plugins: respx-0.22.0, anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

src/core/tests/test_app.py::test_chat_completions_roundtrip FAILED       [100%]

=================================== FAILURES ===================================
_______________________ test_chat_completions_roundtrip ________________________

tmp_path = PosixPath('/tmp/pytest-of-magnus/pytest-12/test_chat_completions_roundtri0')

    @pytest.mark.asyncio
    async def test_chat_completions_roundtrip(tmp_path: Path) -> None:
        service = await build_service(tmp_path)
        app = create_app(service._settings, service=service)
        client = TestClient(app)
    
        payload = {
            "model": "agent-model",
            "messages": [
                {"role": "system", "content": "be helpful"},
                {"role": "user", "content": "Hello"},
            ],
            "metadata": {"tools": []},
        }
    
        response = client.post("/v1/chat/completions", json=payload)
>       assert response.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

src/core/tests/test_app.py:92: AssertionError
----------------------------- Captured stdout call -----------------------------
{
    "name": "POST /v1/chat/completions http receive",
    "context": {
        "trace_id": "0x94c4590471636c28399ba39095d3364c",
        "span_id": "0x609bd7145a52473d",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xbab576e0b85c695d",
    "start_time": "2025-12-22T08:37:25.073881Z",
    "end_time": "2025-12-22T08:37:25.073895Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.request"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0x94c4590471636c28399ba39095d3364c",
        "span_id": "0x7dec4d8aea5ed483",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xbab576e0b85c695d",
    "start_time": "2025-12-22T08:37:35.114481Z",
    "end_time": "2025-12-22T08:37:35.114518Z",
    "status": {
        "status_code": "ERROR"
    },
    "attributes": {
        "asgi.event.type": "http.response.start",
        "http.status_code": 500
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0x94c4590471636c28399ba39095d3364c",
        "span_id": "0x21cf97294a07cd35",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xbab576e0b85c695d",
    "start_time": "2025-12-22T08:37:35.114739Z",
    "end_time": "2025-12-22T08:37:35.114746Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.response.body"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0x94c4590471636c28399ba39095d3364c",
        "span_id": "0x947be10c04bba2b0",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xbab576e0b85c695d",
    "start_time": "2025-12-22T08:37:35.114830Z",
    "end_time": "2025-12-22T08:37:35.114836Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.response.body"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions",
    "context": {
        "trace_id": "0x94c4590471636c28399ba39095d3364c",
        "span_id": "0xbab576e0b85c695d",
        "trace_state": "[]"
    },
    "kind": "SpanKind.SERVER",
    "parent_id": null,
    "start_time": "2025-12-22T08:37:25.073760Z",
    "end_time": "2025-12-22T08:37:35.115518Z",
    "status": {
        "status_code": "ERROR"
    },
    "attributes": {
        "http.scheme": "http",
        "http.host": "testserver",
        "net.host.port": 80,
        "http.flavor": "1.1",
        "http.target": "/v1/chat/completions",
        "http.url": "http://testserver/v1/chat/completions",
        "http.method": "POST",
        "http.server_name": "testserver",
        "http.user_agent": "testclient",
        "net.peer.ip": "testclient",
        "net.peer.port": 50000,
        "http.route": "/v1/chat/completions",
        "http.request.body": "{\"model\":\"agent-model\",\"messages\":[{\"role\":\"system\",\"content\":\"be helpful\"},{\"role\":\"user\",\"content\":\"Hello\"}],\"metadata\":{\"tools\":[]}}",
        "http.status_code": 500,
        "http.response.body": "{\"detail\":\"[Errno -3] Temporary failure in name resolution\"}"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
------------------------------ Captured log call -------------------------------
ERROR    core.core.app:app.py:188 Agent processing failed
Traceback (most recent call last):
  File "/home/magnus/dev/ai-agent-platform/services/agent/src/core/core/app.py", line 183, in _handle_chat_completions
    response = await svc.handle_request(agent_request, session=session)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/dev/ai-agent-platform/services/agent/src/core/core/service.py", line 68, in handle_request
    db_conversation = await session.get(Conversation, conversation_id)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 592, in get
    return await greenlet_spawn(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3680, in get
    return self._get_impl(
           ^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3859, in _get_impl
    return db_load_fn(
           ^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 695, in load_on_pk_identity
    session.execute(
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2239, in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2108, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1187, in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 3285, in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 3309, in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 447, in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 711, in checkout
    rec = pool._do_get()
          ^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/impl.py", line 177, in _do_get
    with util.safe_reraise():
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/impl.py", line 175, in _do_get
    return self._create_connection()
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 388, in _create_connection
    return _ConnectionRecord(self)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 673, in __init__
    self.__connect()
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 899, in __connect
    with util.safe_reraise():
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 895, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/create.py", line 661, in connect
    return dialect.connect(*cargs, **cparams)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 630, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 955, in connect
    await_only(creator_fn(*arg, **kw)),
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/connection.py", line 2443, in connect
    return await connect_utils._connect(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 1249, in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 1218, in _connect
    conn = await _connect_addr(
           ^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 1054, in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 1099, in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 969, in _create_ssl_connection
    tr, pr = await loop.create_connection(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/asyncio/base_events.py", line 1080, in create_connection
    infos = await self._ensure_resolved(
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/asyncio/base_events.py", line 1456, in _ensure_resolved
    return await loop.getaddrinfo(host, port, family=family, type=type,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/asyncio/base_events.py", line 901, in getaddrinfo
    return await self.run_in_executor(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/socket.py", line 963, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
socket.gaierror: [Errno -3] Temporary failure in name resolution
=============================== warnings summary ===============================
../../../../.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/llms/anthropic.py:531
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/llms/anthropic.py:531: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AnthropicResponseContentBlockToolUse(BaseModel):

../../../../.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/rag.py:181
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/rag.py:181: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RAGIngestRequest(BaseModel):

src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/dev/ai-agent-platform/services/agent/src/core/core/app.py:124: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/fastapi/applications.py:4575: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/dev/ai-agent-platform/services/agent/src/core/core/app.py:144: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED src/core/tests/test_app.py::test_chat_completions_roundtrip - assert 500 == 200
 +  where 500 = <Response [500 Internal Server Error]>.status_code
======================== 1 failed, 6 warnings in 14.69s ========================
