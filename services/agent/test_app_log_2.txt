============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.0, pluggy-1.6.0 -- /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/bin/python
cachedir: .pytest_cache
rootdir: /home/magnus/dev/ai-agent-platform/services/agent
configfile: pyproject.toml
plugins: respx-0.22.0, anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

src/core/tests/test_app.py::test_chat_completions_roundtrip FAILED       [100%]

=================================== FAILURES ===================================
_______________________ test_chat_completions_roundtrip ________________________

tmp_path = PosixPath('/tmp/pytest-of-magnus/pytest-13/test_chat_completions_roundtri0')

    @pytest.mark.asyncio
    async def test_chat_completions_roundtrip(tmp_path: Path) -> None:
        service = await build_service(tmp_path)
        app = create_app(service._settings, service=service)
        client = TestClient(app)
    
        payload = {
            "model": "agent-model",
            "messages": [
                {"role": "system", "content": "be helpful"},
                {"role": "user", "content": "Hello"},
            ],
            "metadata": {"tools": []},
        }
    
        response = client.post("/v1/chat/completions", json=payload)
        assert response.status_code == 200
        data = response.json()
        assert data["choices"][0]["message"]["content"].startswith("reply:")
        assert data["metadata"]["tools"] == []
        assert isinstance(data["steps"], list)
        assert data["metadata"]["steps"] == data["steps"]
        assert data["choices"][0]["message"]["metadata"]["steps"] == data["steps"]
    
        follow_payload = {
            "model": "agent-model",
            "conversation_id": data["id"],
            "messages": [
                {"role": "system", "content": "be helpful"},
                {"role": "user", "content": "Hello"},
                {
                    "role": "assistant",
                    "content": data["choices"][0]["message"]["content"],
                },
                {"role": "user", "content": "How are you?"},
            ],
        }
    
        second = client.post("/v1/chat/completions", json=follow_payload)
>       assert second.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

src/core/tests/test_app.py:115: AssertionError
----------------------------- Captured stdout call -----------------------------
{
    "name": "POST /v1/chat/completions http receive",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0x77179d7f7ce9b41e",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x52c560bd4fef98d4",
    "start_time": "2025-12-22T08:38:12.947718Z",
    "end_time": "2025-12-22T08:38:12.947730Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.request"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "planner.generate",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0xaa2136bc97b57e3a",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xa08f8045eb3ad1e3",
    "start_time": "2025-12-22T08:38:12.982992Z",
    "end_time": "2025-12-22T08:38:12.983110Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "step": "plan",
        "model": "ollama/llama3.1:8b",
        "llm.output.size": 202,
        "llm.model": "ollama/llama3.1:8b",
        "plan.step_count": 2,
        "span.end_time": "2025-12-22T08:38:12.983096"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "supervisor.plan_review",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0x918ea1b06f166f4d",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xa08f8045eb3ad1e3",
    "start_time": "2025-12-22T08:38:12.983298Z",
    "end_time": "2025-12-22T08:38:12.983339Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "plan.steps": 2,
        "span.end_time": "2025-12-22T08:38:12.983334"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "executor.step_run.memory",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0xaa9d82659a6a14e1",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xa08f8045eb3ad1e3",
    "start_time": "2025-12-22T08:38:12.985419Z",
    "end_time": "2025-12-22T08:38:12.985499Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "action": "memory",
        "executor": "agent",
        "step": "memory",
        "latency_ms": 0.05625298945233226,
        "status": "ok",
        "step.result": "{'count': 0}",
        "span.end_time": "2025-12-22T08:38:12.985491"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "supervisor.step_review",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0xebfd63f8f86ef764",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xa08f8045eb3ad1e3",
    "start_time": "2025-12-22T08:38:12.985657Z",
    "end_time": "2025-12-22T08:38:12.985690Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "step": "memory",
        "status": "ok",
        "decision": "ok",
        "span.end_time": "2025-12-22T08:38:12.985685"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "llm.call.assistant",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0x0b4f30bcc45d7210",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x902027a7d578d674",
    "start_time": "2025-12-22T08:38:12.985868Z",
    "end_time": "2025-12-22T08:38:12.985886Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "model": "agent-model",
        "step": "completion",
        "llm.output.size": 11,
        "span.end_time": "2025-12-22T08:38:12.985882"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "executor.step_run.completion",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0x902027a7d578d674",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xa08f8045eb3ad1e3",
    "start_time": "2025-12-22T08:38:12.985785Z",
    "end_time": "2025-12-22T08:38:12.985974Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "action": "completion",
        "executor": "litellm",
        "step": "completion",
        "latency_ms": 0.1773029798641801,
        "status": "ok",
        "step.result": "{'completion': 'reply:Hello', 'model': 'agent-model'}",
        "span.end_time": "2025-12-22T08:38:12.985971"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "supervisor.step_review",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0xf164f70d8a0f37d5",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xa08f8045eb3ad1e3",
    "start_time": "2025-12-22T08:38:12.986046Z",
    "end_time": "2025-12-22T08:38:12.986068Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "step": "completion",
        "status": "ok",
        "decision": "ok",
        "span.end_time": "2025-12-22T08:38:12.986065"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "response.finalize",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0xd37186b30957e221",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xa08f8045eb3ad1e3",
    "start_time": "2025-12-22T08:38:12.988213Z",
    "end_time": "2025-12-22T08:38:12.988283Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "span.end_time": "2025-12-22T08:38:12.988275"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "agent.request",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0xa08f8045eb3ad1e3",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x52c560bd4fef98d4",
    "start_time": "2025-12-22T08:38:12.981263Z",
    "end_time": "2025-12-22T08:38:12.988388Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "conversation_id": "c882a8bf-b90d-4137-81dd-25a536e64221",
        "input_size": 5,
        "routing_decision": "AGENTIC",
        "span.end_time": "2025-12-22T08:38:12.988383"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0xec45e1ab9a312352",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x52c560bd4fef98d4",
    "start_time": "2025-12-22T08:38:12.988734Z",
    "end_time": "2025-12-22T08:38:12.988760Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.response.start",
        "http.status_code": 200
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0x197b25fd9fe28e96",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x52c560bd4fef98d4",
    "start_time": "2025-12-22T08:38:12.988891Z",
    "end_time": "2025-12-22T08:38:12.988898Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.response.body"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0x7c5fa4101eac2827",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x52c560bd4fef98d4",
    "start_time": "2025-12-22T08:38:12.988973Z",
    "end_time": "2025-12-22T08:38:12.988978Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.response.body"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions",
    "context": {
        "trace_id": "0xe494ae11a640548bf4054ed8eee3f33e",
        "span_id": "0x52c560bd4fef98d4",
        "trace_state": "[]"
    },
    "kind": "SpanKind.SERVER",
    "parent_id": null,
    "start_time": "2025-12-22T08:38:12.947596Z",
    "end_time": "2025-12-22T08:38:12.989039Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "http.scheme": "http",
        "http.host": "testserver",
        "net.host.port": 80,
        "http.flavor": "1.1",
        "http.target": "/v1/chat/completions",
        "http.url": "http://testserver/v1/chat/completions",
        "http.method": "POST",
        "http.server_name": "testserver",
        "http.user_agent": "testclient",
        "net.peer.ip": "testclient",
        "net.peer.port": 50000,
        "http.route": "/v1/chat/completions",
        "http.request.body": "{\"model\":\"agent-model\",\"messages\":[{\"role\":\"system\",\"content\":\"be helpful\"},{\"role\":\"user\",\"content\":\"Hello\"}],\"metadata\":{\"tools\":[]}}",
        "http.status_code": 200,
        "http.response.body": "{\"id\":\"c882a8bf-b90d-4137-81dd-25a536e64221\",\"object\":\"chat.completion\",\"created\":1766392692,\"model\":\"agent-model\",\"choices\":[{\"index\":0,\"finish_reason\":\"stop\",\"message\":{\"role\":\"assistant\",\"content\":\"reply:Hello\",\"metadata\":{\"tools\":[],\"plan\":{\"steps\":[{\"id\":\"memory\",\"label\":\"Fetch memories\",\"executor\":\"agent\",\"action\":\"memory\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null},{\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"executor\":\"litellm\",\"action\":\"completion\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null}],\"description\":null},\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"},\"steps\":[{\"type\":\"plan\",\"status\":\"created\",\"description\":null,\"plan\":{\"steps\":[{\"id\":\"memory\",\"label\":\"Fetch memories\",\"executor\":\"agent\",\"action\":\"memory\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null},{\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"executor\":\"litellm\",\"action\":\"completion\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null}],\"description\":null},\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"}},{\"type\":\"plan_step\",\"id\":\"memory\",\"label\":\"Fetch memories\",\"action\":\"memory\",\"executor\":\"agent\",\"tool\":null,\"status\":\"ok\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\"},\"result\":{\"count\":0},\"decision\":\"ok\"},{\"type\":\"plan_step\",\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"action\":\"completion\",\"executor\":\"litellm\",\"tool\":null,\"status\":\"ok\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\"},\"result\":{\"completion\":\"reply:Hello\",\"model\":\"agent-model\"},\"decision\":\"ok\"},{\"type\":\"completion\",\"provider\":\"litellm\",\"model\":\"agent-model\",\"status\":\"ok\",\"plan_step_id\":\"completion\",\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"}}]}}}],\"steps\":[{\"type\":\"plan\",\"status\":\"created\",\"description\":null,\"plan\":{\"steps\":[{\"id\":\"memory\",\"label\":\"Fetch memories\",\"executor\":\"agent\",\"action\":\"memory\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null},{\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"executor\":\"litellm\",\"action\":\"completion\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null}],\"description\":null},\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"}},{\"type\":\"plan_step\",\"id\":\"memory\",\"label\":\"Fetch memories\",\"action\":\"memory\",\"executor\":\"agent\",\"tool\":null,\"status\":\"ok\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\"},\"result\":{\"count\":0},\"decision\":\"ok\"},{\"type\":\"plan_step\",\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"action\":\"completion\",\"executor\":\"litellm\",\"tool\":null,\"status\":\"ok\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\"},\"result\":{\"completion\":\"reply:Hello\",\"model\":\"agent-model\"},\"decision\":\"ok\"},{\"type\":\"completion\",\"provider\":\"litellm\",\"model\":\"agent-model\",\"status\":\"ok\",\"plan_step_id\":\"completion\",\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"}}],\"metadata\":{\"tools\":[],\"plan\":{\"steps\":[{\"id\":\"memory\",\"label\":\"Fetch memories\",\"executor\":\"agent\",\"action\":\"memory\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null},{\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"executor\":\"litellm\",\"action\":\"completion\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null}],\"description\":null},\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"},\"steps\":[{\"type\":\"plan\",\"status\":\"created\",\"description\":null,\"plan\":{\"steps\":[{\"id\":\"memory\",\"label\":\"Fetch memories\",\"executor\":\"agent\",\"action\":\"memory\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null},{\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"executor\":\"litellm\",\"action\":\"completion\",\"tool\":null,\"args\":{},\"description\":null,\"provider\":null}],\"description\":null},\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"}},{\"type\":\"plan_step\",\"id\":\"memory\",\"label\":\"Fetch memories\",\"action\":\"memory\",\"executor\":\"agent\",\"tool\":null,\"status\":\"ok\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\"},\"result\":{\"count\":0},\"decision\":\"ok\"},{\"type\":\"plan_step\",\"id\":\"completion\",\"label\":\"Compose assistant reply\",\"action\":\"completion\",\"executor\":\"litellm\",\"tool\":null,\"status\":\"ok\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\"},\"result\":{\"completion\":\"reply:Hello\",\"model\":\"agent-model\"},\"decision\":\"ok\"},{\"type\":\"completion\",\"provider\":\"litellm\",\"model\":\"agent-model\",\"status\":\"ok\",\"plan_step_id\":\"completion\",\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"a08f8045eb3ad1e3\",\"trace\":{\"trace_id\":\"e494ae11a640548bf4054ed8eee3f33e\",\"span_id\":\"d37186b30957e221\"}}]}}"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http receive",
    "context": {
        "trace_id": "0xfc2e705e10db00e0e0deb049b898e69d",
        "span_id": "0x6b1f59780bba9988",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x967d7c7d9b339924",
    "start_time": "2025-12-22T08:38:12.991068Z",
    "end_time": "2025-12-22T08:38:12.991078Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.request"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0xfc2e705e10db00e0e0deb049b898e69d",
        "span_id": "0x1dea0ed4f9a47853",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x967d7c7d9b339924",
    "start_time": "2025-12-22T08:38:12.995394Z",
    "end_time": "2025-12-22T08:38:12.995413Z",
    "status": {
        "status_code": "ERROR"
    },
    "attributes": {
        "asgi.event.type": "http.response.start",
        "http.status_code": 500
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0xfc2e705e10db00e0e0deb049b898e69d",
        "span_id": "0x97a6bcfb497c892b",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x967d7c7d9b339924",
    "start_time": "2025-12-22T08:38:12.995539Z",
    "end_time": "2025-12-22T08:38:12.995545Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.response.body"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions http send",
    "context": {
        "trace_id": "0xfc2e705e10db00e0e0deb049b898e69d",
        "span_id": "0xbd50ba3f94d80228",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0x967d7c7d9b339924",
    "start_time": "2025-12-22T08:38:12.995619Z",
    "end_time": "2025-12-22T08:38:12.995624Z",
    "status": {
        "status_code": "UNSET"
    },
    "attributes": {
        "asgi.event.type": "http.response.body"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
{
    "name": "POST /v1/chat/completions",
    "context": {
        "trace_id": "0xfc2e705e10db00e0e0deb049b898e69d",
        "span_id": "0x967d7c7d9b339924",
        "trace_state": "[]"
    },
    "kind": "SpanKind.SERVER",
    "parent_id": null,
    "start_time": "2025-12-22T08:38:12.990989Z",
    "end_time": "2025-12-22T08:38:12.995668Z",
    "status": {
        "status_code": "ERROR"
    },
    "attributes": {
        "http.scheme": "http",
        "http.host": "testserver",
        "net.host.port": 80,
        "http.flavor": "1.1",
        "http.target": "/v1/chat/completions",
        "http.url": "http://testserver/v1/chat/completions",
        "http.method": "POST",
        "http.server_name": "testserver",
        "http.user_agent": "testclient",
        "net.peer.ip": "testclient",
        "net.peer.port": 50000,
        "http.route": "/v1/chat/completions",
        "http.request.body": "{\"model\":\"agent-model\",\"conversation_id\":\"c882a8bf-b90d-4137-81dd-25a536e64221\",\"messages\":[{\"role\":\"system\",\"content\":\"be helpful\"},{\"role\":\"user\",\"content\":\"Hello\"},{\"role\":\"assistant\",\"content\":\"reply:Hello\"},{\"role\":\"user\",\"content\":\"How are you?\"}]}",
        "http.status_code": 500,
        "http.response.body": "{\"detail\":\"Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/starlette/middleware/base.py:144> cb=[TaskGroup._spawn.<locals>.task_done() at /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:805]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop\"}"
    },
    "events": [],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.39.1",
            "service.name": "AI Agent Server"
        },
        "schema_url": ""
    }
}
------------------------------ Captured log call -------------------------------
ERROR    core.core.app:app.py:188 Agent processing failed
Traceback (most recent call last):
  File "/home/magnus/dev/ai-agent-platform/services/agent/src/core/core/app.py", line 183, in _handle_chat_completions
    response = await svc.handle_request(agent_request, session=session)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/dev/ai-agent-platform/services/agent/src/core/core/service.py", line 68, in handle_request
    db_conversation = await session.get(Conversation, conversation_id)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 592, in get
    return await greenlet_spawn(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3680, in get
    return self._get_impl(
           ^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3859, in _get_impl
    return db_load_fn(
           ^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 695, in load_on_pk_identity
    session.execute(
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2249, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2366, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 520, in _prepare_and_execute
    await adapt_connection._start_transaction()
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 850, in _start_transaction
    self._handle_exception(error)
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 799, in _handle_exception
    raise error
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 848, in _start_transaction
    await self._transaction.start()
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/transaction.py", line 146, in start
    await self._connection.execute(query)
  File "/home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/asyncpg/connection.py", line 354, in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 369, in query
RuntimeError: Task <Task pending name='starlette.middleware.base.BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro' coro=<BaseHTTPMiddleware.__call__.<locals>.call_next.<locals>.coro() running at /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/starlette/middleware/base.py:144> cb=[TaskGroup._spawn.<locals>.task_done() at /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:805]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
=============================== warnings summary ===============================
../../../../.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/llms/anthropic.py:531
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/llms/anthropic.py:531: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AnthropicResponseContentBlockToolUse(BaseModel):

../../../../.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/rag.py:181
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/litellm/types/rag.py:181: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RAGIngestRequest(BaseModel):

src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/dev/ai-agent-platform/services/agent/src/core/core/app.py:124: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/fastapi/applications.py:4575: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/dev/ai-agent-platform/services/agent/src/core/core/app.py:144: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/sqlalchemy/sql/schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/dev/ai-agent-platform/services/agent/src/core/observability/tracing.py:214: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    span.set_attribute("span.end_time", datetime.utcnow().isoformat())

src/core/tests/test_app.py::test_chat_completions_roundtrip
  /home/magnus/.cache/pypoetry/virtualenvs/ai-agent-platform-hIn861qG-py3.12/lib/python3.12/site-packages/pydantic/main.py:250: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED src/core/tests/test_app.py::test_chat_completions_roundtrip - assert 500 == 200
 +  where 500 = <Response [500 Internal Server Error]>.status_code
======================== 1 failed, 20 warnings in 4.64s ========================
