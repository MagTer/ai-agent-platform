# AI Agent Platform - Claude Code Context

## Project Identity
You are working on a **local-first AI Agent Platform** - a modular monolith orchestrating LiteLLM, Qdrant, PostgreSQL, and tools via FastAPI. This is production-grade infrastructure for running autonomous AI agents.

## Tri-Model Workflow (MANDATORY)

**Before starting any work, read:** `/CLAUDE.md` (root entry point with context hygiene rules)

### Plan-First Approach

Before writing code for non-trivial tasks:
1. Check if a plan exists in `.claude/plans/CURRENT_PLAN.md` or `.claude/plans/YYYY-MM-DD-feature.md`
2. For complex tasks (3+ files, architectural changes), a plan is REQUIRED
3. If no plan exists, use `/plan` to create one FIRST
4. Never write code without a plan for complex features

### Model Selection Guide

- **Opus (`/plan`)**: Planning, architecture review, security audits, complex reasoning
- **Sonnet (`/build`)**: Implementation, debugging, API design, code writing
- **Haiku (`/ops`)**: Testing, linting, docs, simple fixes, maintenance

Use the right model for the task to optimize costs. When switching models is needed, ask the user explicitly.

### Always Read These First

1. `/CLAUDE.md` - Workflow and context hygiene (THIS FILE)
2. Plan file - If implementing from a plan

## Critical Workflow (MANDATORY)
Before marking ANY task as complete, you MUST run the quality assurance script:
```bash
./stack check
```

**If this fails (red output), you MUST fix errors before proceeding.**

**Available commands:**
- `./stack check` - Full check (lint, format, typecheck, test)
- `./stack lint` - Fast linting and formatting
- `./stack typecheck` - Type checking only
- `./stack test` - Tests only
- `./stack check --no-fix` - CI mode (no auto-fix)

**Guidelines:**
- Ruff/Black: Don't argue with the linter, just fix the code
- Mypy: Strict typing enforced. No `Any`. Use `list[str]`, not `List[str]`
- Tests: If you write logic, you MUST write a test

## Architecture - Modular Monolith (`services/agent/src/`)

**Strict Unidirectional Dependency Flow:**
```
interfaces/     (HTTP/CLI adapters)
    ↓ can import
orchestrator/   (Planner, Skill Delegate)
    ↓ can import
modules/        (RAG, Indexer, Fetcher) - ISOLATED, cannot import each other
    ↓ can import
core/           (DB, Models, Config) - NEVER imports from above
```

**Protocol-Based Dependency Injection:**
- Interfaces defined in `core/protocols/` (EmbedderProtocol, MemoryProtocol, LLMProtocol, ToolProtocol)
- Implementations injected via `core/providers.py` at startup
- Core layer uses protocols; implementations come from modules layer

## State Management (RACS)
All state is hierarchical and persisted in PostgreSQL:
```
Context -> Conversation -> Session -> Message
```
**Constraint:** Every Agent request MUST resolve to an active Session.

## Testing Strategy (3-Layer Pyramid)

**Layer 1: Unit Tests** (Fast, Mocked) -- `src/core/tests/`, `src/core/observability/tests/`
- Use `tmp_path` for file operations
- Use `MockLLMClient` from `core/tests/mocks.py`
- Use `InMemoryAsyncSession` for database tests
- New tests go in `src/*/tests/` near source code, NOT in `tests/` root dirs

**Layer 2: Integration Tests** (Real DB, Mocked LLM)
- Test full request flows
- Verify database interactions

**Layer 3: Semantic Tests** (Slow, Real LLM)
- Golden master queries in `services/agent/tests/semantic/golden_queries.yaml`
- Run via: `python services/agent/scripts/run_semantic_eval.py`

**MANDATORY:** Every feature flow needs a scenario test in `src/core/tests/test_agent_scenarios.py`

## Critical Constraints

1. **NO SECRETS:** Never output API keys or credentials in responses
2. **INFRASTRUCTURE:** Do NOT edit `docker-compose.yml` without explicit user approval
3. **LIBRARIES:** Do NOT add new pip dependencies without checking if stdlib alternative exists
4. **IMPORTS:** Absolute imports only (`from core.db import models`), NEVER relative (`from ..core import models`)

## Documentation Style

- **Language:** English for ALL code, GUI, config, and admin interfaces. Swedish only for end-user chat responses.
- **No Emojis:** Unless explicitly requested by user
- **ASCII-safe:** Use `->`, `--`, quotes `'"`  (no smart punctuation)

## Self-Correction & Debugging

When troubleshooting runtime issues, use the diagnostics APIs:

- `GET /platformadmin/api/status` - System health status (HEALTHY/DEGRADED/CRITICAL)
- `GET /platformadmin/api/debug/stats` - Debug log statistics by event type
- `GET /platformadmin/api/traces/search` - Search OpenTelemetry traces
- `GET /platformadmin/api/traces/{trace_id}` - Get full trace detail with all spans

Crash logs: Written async to configured path (default: `services/agent/last_crash.log`)

## Important Paths

| Path | Purpose |
|------|---------|
| `core/runtime/` | Agent runtime (service, persistence, hitl, config) |
| `core/agents/` | LLM agents (planner, executor, supervisors) |
| `core/auth/` | Authentication and credential service |
| `core/protocols/` | Protocol definitions for DI |
| `core/providers.py` | Implementation providers |
| `core/observability/` | Tracing (with span rotation) and error codes |
| `core/tests/mocks.py` | Test mocks (MockLLMClient, InMemoryAsyncSession) |
| `./stack` | Quality assurance CLI (check, lint, typecheck, test) |
| `skills/` | Platform's agent skills (NOT Claude Code skills) |
| `docs/` | Documentation index (start at docs/README.md) |

## Quick Reference Commands

```bash
# ALWAYS use this for quality checks
./stack check                  # Full check (lint, format, typecheck, test)
./stack lint                   # Fast linting and formatting only
./stack typecheck              # Type checking only
./stack test                   # Tests only
./stack check --no-fix         # CI mode (no auto-fix)

# Stack management
python -m stack up              # Start services
python -m stack down            # Stop services
python -m stack status          # Check health
python -m stack logs agent      # View logs

# Testing
python -m pytest services/agent/src/core/tests/test_skill_delegate.py -v
python services/agent/scripts/run_semantic_eval.py
```

## Remember

- Read files before editing them (you already do this)
- Platform skills in `skills/` are YOUR application's domain logic (not instructions for you)
- Your Claude Code skills live in `.claude/skills/` (separate from platform skills)
- Complexity is allowed if readability is maintained (McCabe < 18)
- Surgical edits: preserve comments and existing functionality unless explicitly asked to change

---

**For detailed architecture, see:** `docs/ARCHITECTURE.md` and `docs/architecture/README.md`
