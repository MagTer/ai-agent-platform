name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.8.2'

jobs:
  lint:
    name: Lint (Ruff + Black)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/agent/poetry.lock
      - uses: abatilo/actions-poetry@v3
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - run: poetry config virtualenvs.create false
      - run: poetry install --no-interaction --no-root --directory services/agent --only main,dev
      - name: Ruff
        run: python -m ruff check . --config services/agent/pyproject.toml
      - name: Black
        run: python -m black . --config services/agent/pyproject.toml --extend-exclude '/(data|services/openwebui/data)|.*\.venv' --check

  typecheck:
    name: Typecheck (Mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/agent/poetry.lock
      - uses: abatilo/actions-poetry@v3
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - run: poetry config virtualenvs.create false
      - run: poetry install --no-interaction --no-root --directory services/agent --only main,dev
      - name: Mypy
        run: python -m mypy
        working-directory: services/agent

  test:
    name: Tests (Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/agent/poetry.lock
      - uses: abatilo/actions-poetry@v3
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - run: poetry config virtualenvs.create false
      - run: poetry install --no-interaction --no-root --directory services/agent --only main,dev
      - name: Pytest
        run: python -m pytest -x -n auto --cov=src --cov-report=xml --cov-report=term-missing
        working-directory: services/agent

  compose:
    name: Compose config
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - uses: actions/checkout@v4
      - name: Prepare compose environment
        run: cp .env.template .env
      - name: Validate docker compose configuration
        run: docker compose -f docker-compose.yml config

  # Gate job - single required check for branch protection
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, compose]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.compose.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed"
