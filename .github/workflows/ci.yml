name: CI

on:
  pull_request:

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.8.2'

jobs:
  lint:
    name: Lint (Ruff + Black)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: abatilo/actions-poetry@v3
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - run: poetry config virtualenvs.in-project true
      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: services/agent/.venv
          key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('services/agent/poetry.lock') }}
      - run: poetry install --no-interaction --no-root --directory services/agent --only main,dev
      - run: echo "${{ github.workspace }}/services/agent/.venv/bin" >> $GITHUB_PATH
      - name: Ruff
        run: python -m ruff check . --config services/agent/pyproject.toml
      - name: Black
        run: python -m black . --config services/agent/pyproject.toml --extend-exclude '/(data|services/openwebui/data)|.*\.venv' --check

  typecheck:
    name: Typecheck (Mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: abatilo/actions-poetry@v3
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - run: poetry config virtualenvs.in-project true
      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: services/agent/.venv
          key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('services/agent/poetry.lock') }}
      - run: poetry install --no-interaction --no-root --directory services/agent --only main,dev
      - run: echo "${{ github.workspace }}/services/agent/.venv/bin" >> $GITHUB_PATH
      - name: Mypy
        run: python -m mypy
        working-directory: services/agent

  test:
    name: Tests (Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for testmon change detection
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: abatilo/actions-poetry@v3
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - run: poetry config virtualenvs.in-project true
      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: services/agent/.venv
          key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('services/agent/poetry.lock') }}
      - run: poetry install --no-interaction --no-root --directory services/agent --only main,dev
      - run: echo "${{ github.workspace }}/services/agent/.venv/bin" >> $GITHUB_PATH
      - name: Restore testmon cache
        uses: actions/cache@v4
        with:
          path: services/agent/.testmondata
          key: testmon-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ github.base_ref }}-${{ hashFiles('services/agent/poetry.lock') }}
          restore-keys: |
            testmon-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ github.base_ref }}-
            testmon-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-
      - name: Pytest (testmon - affected tests only)
        run: python -m pytest -x --testmon --cov=src --cov-report=xml --cov-report=term-missing
        working-directory: services/agent
        # NOTE: testmon skips tests unaffected by changes; incompatible with xdist (-n auto)
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: services/agent/coverage.xml
        if: always()

  compose:
    name: Compose config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare compose environment
        run: cp .env.template .env
      - name: Validate docker compose configuration
        run: docker compose -f docker-compose.yml config

  trivy:
    name: Container Security Scan (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - name: Build Docker image
        run: |
          docker build \
            -t agent:${{ github.sha }} \
            -f services/agent/Dockerfile \
            services/agent
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'agent:${{ github.sha }}'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: '1'
      - name: Generate Trivy SARIF report
        if: always()
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'agent:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: '0'
      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  dependency-audit:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: abatilo/actions-poetry@v3
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - run: poetry config virtualenvs.in-project true
      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: services/agent/.venv
          key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('services/agent/poetry.lock') }}
      - run: poetry install --no-interaction --no-root --directory services/agent --only main,dev
      - run: echo "${{ github.workspace }}/services/agent/.venv/bin" >> $GITHUB_PATH
      - run: pip install --upgrade pip pip-audit
      - name: Run pip-audit
        run: pip-audit --strict --desc

  # Gate job - single required check for branch protection
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, compose, trivy, dependency-audit]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.compose.result }}" != "success" ] || \
             [ "${{ needs.trivy.result }}" != "success" ] || \
             [ "${{ needs.dependency-audit.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed"
